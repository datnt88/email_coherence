<s> (I changed s/www-validator/public-qa-dev/)  </s>
<s> Another one ...  </s>
<s> Thanks Vivien, the error message is generated by the CGI.pm Perl module.  </s>
<s> It's either a bug in our code, in CGI.pm or in the browser of these users.  </s>
<s> Could you ask these users to report details on what browsers they have used, etc. to www-validator or forward their mails to me so I can ask them?  </s>
<s> Some more thoughts: the error message was "Malformed multipart POST" but the feedback said "when trying to validate online HTML documents"; that combination makes no sense to me.  </s>
<s> Did the user use upload or URI submission?  </s>
<s> If upload, at least some (old) versions of Opera did have issues with file uploads, but AFAIK CGI.pm had a workaround for this already in version 2.89, and v.w.o has 3.01.  </s>
<s> If it was validation using a URI, I have no explanation.  </s>
<s> We should probably configure validator.w3.org so that it lists www-validator or public-qa-dev as contact address rather than web-human...  </s>
<s> public-qa-dev++  </s>
<s> -----BEGIN PGP SIGNED MESSAGE----- Hash: SHA1  </s>
<s> Except "public"-qa-dev is subscriber-only... Personally I could live with having Apache on v.w3.org give web-human as the contact adress ??? it makes sense to me that all web service related issues get adressed to the same place within the w3.org domain, and the web-human will presumably direct questions to the right place for v.w3.org as for all other sections of the greater w3.org site ??? but then it's not me that has to handle the web-human mail queue so... :-) These are the same customers you are referring to whom Microsoft thought would need MS Bob and the Talking Paperclip?  </s>
<s> One thing is to give them enough rope to hang themselves, but a boobytrapped thermonuclear weapon running on a rand(time) countdown...  </s>
<s> Is that really wise?  </s>
<s> - Me to MS rep.  </s>
<s> -----BEGIN PGP SIGNATURE----- Version: PGP SDK 3.0.3  </s>
<s> iQA/AwUBQK+5aqPyPrIkdfXsEQJnywCdFOgat0bJ73SYqr7qV6cS/esgDLcAoPOn ibvewJ1BhaOOmbV2YKCnx+4t =CCQF -----END PGP SIGNATURE-----  </s>
<s> Did we change the CGI.pm during the upgrade / server change?  </s>
<s> Could someone have a look at the error logs for some insight?  </s>
<s> I have no idea.  </s>
<s> Olivier?  </s>
<s> It's a bit hard to find the interesting entries since validator is quite an errorlog-trasher (still, even though I managed to get some of the noisiest bugs fixed for 0.6.6).  </s>
<s> Anyway, there are 46 "Malformed multipart POST" and "Malformed multipart POST: data truncated" entries in today's error log, but unfortunately there doesn't seem to be anything terribly interesting nearby.  </s>
<s> Samples (as well as POST examples with the same timestamp from access log, or complete_log as it's called on v.w.o) with IP addresses masked: [Sat May 22 14:41:28 2004] check: Malformed multipart POST: data truncated [Sat May 22 14:50:08 2004] check: Malformed multipart POST 2004-05-22T14:41:28Z 200 7054 na /usr/local/validator/httpd/cgi-bin/check xxx.xxx.xxx.xxx - "POST /check HTTP/1.1" "http://validator.w3.org/" "text/html" "-" "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; .NET  </s>
<s> CLR 1.1.4322)"  </s>
<s> "validator.w3.org" 2004-05-22T14:41:28Z 200 265 na /usr/local/validator/httpd/cgi-bin/check yyy.yyy.yyy.yyy - "POST /check HTTP/1.1" "-" "text/html" "-" "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0) Opera 7.23 [en]" "validator.w3.org" 2004-05-22T14:50:08Z 200 249 na /usr/local/validator/httpd/cgi-bin/check xxx.xxx.xxx.xxx - "POST /check HTTP/1.1" "http://validator.w3.org/" "text/html" "-" "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; .NET  </s>
<s> CLR 1.1.4322)"  </s>
<s> "validator.w3.org"  </s>
<s> Note that the response status has been 200 for all those POSTs.  </s>
<s> There are also quite a few some weird error log entries, not necessarily near the above, like: [Sat May 22 16:22:12 2004] [error] [client zzz.zzz.zzz.zzz] request failed: erroneous characters after protocol string: t reproduce in part or whole without permission.  </s>
<s> br While peeking into the logs, here's a bunch of URIs, checking all of which have resulted in "500 internal server error" today, some examples: My local installation and qa-dev seem to be fine with this, but the memory footprint of the "check" process peaks at 170MB (!) in my local instance just before the validation finishes.  </s>
<s> Ditto, peak memory usage 107MB.  </s>
<s> Ditto, plus takes ages to validate, I already thought this would kill my box until it eventually finished, peak mem usage 141MB.  </s>
<s> Running "top" on v.w.o suggests that it seems to kill the "check" process once its footprint reaches 100MB when validating any of the above URLs.  </s>
<s> I did not see any related configuration or limits in httpd.conf, and the box does not run out of memory or anything.  </s>
<s> Nothing  </s>
<s> meaningful in the error log when it terminates either, only: [Sat May 22 18:21:20 2004] [error] [client nnn.nnn.nnn.nnn]  </s>
<s> Premature end of script headers: /usr/local/validator/httpd/cgi-bin/check  </s>
<s> BTW, Normal, smallish validation cases seem to take 10MB or so per "check" process on my box, so 100+ MB is pretty much... ideas?  </s>
<s> There is also one 500 from what is apparently caused by someone repeatedly (7ish times) clicking the referer badge in the lower right hand corner of the results page after having validated a pretty large document with show source and show parse tree options on, causing ovbiously pretty heavy recursion and an URL with length of about 2k... any ideas how we could prevent this?  </s>
<s> -----BEGIN PGP SIGNED MESSAGE----- Hash: SHA1  </s>
<s> And we should probably make an effort to reduce this problem even further fairly quickly.  </s>
<s> Process size will balloon with input document size (and hence complexity) since each element has a gazillion attributes who will show up in the ESIS whether they're in the physical markup or not.  </s>
<s> A normal document has a very large markup:content ratio; the cited documents have inordinatly much markup compared to the amount of data in them.  </s>
<s> Well, or at least that's my theory.  </s>
<s> :-) BTW, Bj??rn has (on IRC) just suggested some optimizations that can be used to avoid some of this overhead in a number of cases.  </s>
<s> I'll have a look at whether that can reasonably be done for 0.6.7.  </s>
<s> The bug on this has been targetted for 0.7 IIRC.  </s>
<s> Which means these are probably either Apache compile-time limits or Debian kernel ulimits.  </s>
<s> Look for the User-Agent or similar distinguishing characteristic of the incoming request, and if it's ourselves we append an extra token ("recursive") to out User-Agent string.  </s>
<s> If a request comes in with "recursive" we throw a fatal error.  </s>
<s> Add in a configurable prmitted recursion level perhaps... "Temper Temper!  </s>
<s> Mr. Dre?  </s>
<s> Mr. NWA?  </s>
<s> Mr. AK, comin?? straight outta Compton and y'all better make way?" -- eminem -----BEGIN PGP SIGNATURE----- Version: PGP SDK 3.0.3  </s>
<s> iQA/AwUBQK/gHqPyPrIkdfXsEQLL5QCg1HJZgRVZhZtOEDaQ1B1Qwkrf4F0An3U4 SWGhS3bzWDuWdgTEBRlHLNo7 =6FgA -----END PGP SIGNATURE-----  </s>
<s> Yep. Attached is a couple of lowly scripts I've used every once in a while (when bored or something :), first grab some URLs from the access log on v.w.o: ./graburls.sh 3000  urls.txt ...then transfer urls.txt to my box and replay on a local validator instance, 'tail -f'ing its error log in another shell: ./replay-validator.sh  urls.txt  </s>
<s> I think we did, by changing the base perl from 5.6.1 (with CGI v2.752) to 5.8.3 (with CGI v3.01).  </s>
<s> olivier  </s>
<s> IOW, someone should try to figure out what's different between those versions and how to restore the old behavior?  </s>
