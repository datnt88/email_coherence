<s> Proxies share many problems with routers.  </s>
<s> Among these, a catastrophic event is the creation of a loop of proxies, originating from the misconfiguration of one of more of the members of the loop.  </s>
<s> While the configuration of proxies does not really belong in the HTTP protocol, it helps a lot having a way to detect the existence of loops, or at least minimising its bad effects.  </s>
<s> In this particular case, the ability to identify and break loops is of fundamental importance because even a single misconfigured proxy can create large loops and completely disrupt service on the proxies which are part of the loop.  </s>
<s> Note that it is very easy to break service on a given proxy: the misconfigured proxy, A, only needs to send a request to a proxy (P) specifying an URI on A itself.  </s>
<s> With the complicity of an intermediate node A' on the loop P can loose any possibility of detecting the existence of the loop.  </s>
<s> +-- A --(A')--- P ----+ +------------ ----------+ Now, while it is true that a program can easily be written to induce such a behaviour, my point is that the above scenario can be introduced too easily because of misconfiguration of a node running standard code.  </s>
<s> Invoking the "robustness principle", and similarly to IP, I propose the addition of a Time-To-Live field somewhere in the *compulsory* headers for the request.  </s>
<s> A node receiving a request must decrement the TTL and can only forward it if the TTL is  0. If the TTL goes to 0, the node should reply with an error message to help the location of the problem.  </s>
<s> The TTL can either be a separate, compulsory header field, or appear as an additional parameter in the Request-Line, perhaps right after the protocol version.  </s>
<s> A note: a malicious node A, can create an artificial loop even with a TTL field, and even if an authentication mechanism is used to allow a proxy to accept and forward requests (although, in this case the malicious process must first authenticate itself).  </s>
<s> Actually, it is not even necessary that data are actually flowing on the connection, it suffices that enough requests are sent to P while keeping it waiting for responses: the node running P will quickly hit against some limit (file descriptors, process table entries, max concurrent requests...).  </s>
<s> An alternative approach, namely the addition, in the request, of a "history" of already visited nodes, does not help either.  </s>
<s> A "robust" proxy should certainly check for requests coming from a single node, and avoid allocating a significant fraction of its resource to it.  </s>
<s> Luigi Luigi Rizzo Dip.  </s>
<s> di Ingegneria dell'Informazione  </s>
<s> The Forwarded header field was created for this purpose.  </s>
<s> Is it insufficient?  </s>
<s> ...Roy T. Fielding Department of Information &amp; Computer Science (fielding@ics.uci.edu)  </s>
<s> Finally I could get a copy of the 1.1 draft.  </s>
<s> The Forwarded: header can actually be used to detect loops.  </s>
<s> However, * it is not compulsory (although a node willing to avoid loops will certainly insert it and detect the loop); * in principle, it does not prevent the occurrence of arbitrarily long paths (although a node can decide not to pass a request which has been "Forwarded:" too many times); and these reasons make me like better the use of a *compulsory* TTL field as a loop detector (which is also simpler to manage).  </s>
<s> The "Forwarded:" header was inspired from email, but email loops are different from http loops.  </s>
<s> The former are built one step at a time, in a store-and-forward fashion: it might take hours before a loop is complete and detected, during this time the system does not allocate resources other than the storage for a single copy of the message.  </s>
<s> But http allocates resources on all nodes, so loops are more expensive for the network.  </s>
<s> Luigi Luigi Rizzo Dip.  </s>
<s> di Ingegneria dell'Informazione  </s>
<s> The Forwarded: header can actually be used to detect loops.  </s>
<s> However, * it is not compulsory (although a node willing to avoid loops will certainly insert it and detect the loop); * in principle, it does not prevent the occurrence of arbitrarily long paths (although a node can decide not to pass a request which has been "Forwarded:" too many times); and these reasons make me like better the use of a *compulsory* TTL field as a loop detector (which is also simpler to manage).  </s>
<s> When I first read your proposal for a TTL field, I had the same reaction that Roy seems to have had: this isn't really necessary.  </s>
<s> The Forwarded: header allows any proxy to detect loops through itself, and can support that task without being mandatory.  </s>
<s> And do we have any evidence that forwarding loops are a real problem?  </s>
<s> Routing loops occur because our routing protocols are automatic and dynamic, and so can do stupid things rapidly and for transient periods.  </s>
<s> HTTP forwarding loops, on the other hand, would be created by humans and should thus be both less frequent and less transient.  </s>
<s> I'm also not that worried about arbitrarily long forwarding paths (what's the harm?), and I would be worried about o the danger that some browser would set the TTL too short, thus causing hard-to-debug service problems  </s>
<s> othe overhead of managing yet another mandatory header field on every request, just to avoid a very rare problem.  </s>
<s> However: after I thought about this some more, I realized that there is an entirely different reason to include a TTL header in HTTP.  </s>
<s> There are two main uses for the TTL field in IP headers: first, to avoid routing loops and long-delayed packets.  </s>
<s> Second, to make "traceroute" work.  </s>
<s> I would bet that most TTL "failures" in today's Internet are from traceroute users, not routing loops.  </s>
<s> Traceroute has proved to be an essential tool in debugging IP-level problems.  </s>
<s> We ought to be thinking about providing analogous debugging tools at the HTTP level.  </s>
<s> For example, "how come the users on my LAN are having trouble reaching server www.xxx.com?"  </s>
<s> It would be really nice to have a "trace-http-path" program, like traceroute but displaying the HTTP-level forwarding path instead of the IP-level routing path.  </s>
<s> A TTL header in HTTP would make that quite easy.  </s>
<s> I would NOT make this a mandatory header; that is, it would not be set on most requests.  </s>
<s> Thus we would avoid imposing additional overhead on normal requests.  </s>
<s> However, I would make it mandatory for proxies and servers to honor and process it.  </s>
<s> (Since HTTP 1.0 proxies would not understand it, they would not appear in trace-http-path displays, but HTTP 1.0 servers would respond to the attached GET method and so one could see the end point of any path.) trace-http-path would work like traceroute: send a series of requests with TTLs starting at 1 and increasing.  </s>
<s> A proxy seeing a TTL header would be required to decrement it by 1 before forwarding.  </s>
<s> If the TTL reaches zero, the proxy would be required to NOT forward the request, and to return a distinctive status code meaning "TTL expired".  </s>
<s> (Should this be 5xx status code, or should we invent a 6xx series for proxy-specific errors?)  </s>
<s> Along with the error code, the proxy would return a short text message that includes the URI of the proxy (as in the Forwarded: header) and perhaps optional information about the proxy's configuration and/or status (such as load average or cache hit rate).  </s>
<s> Note that trace-http-path need not be a separate program; it could be a function built into a browser client.  </s>
<s> -Jeff  </s>
<s> At the moment this is true, but one might try to use some protocol for the automatic configuration of proxies -- actually, caches (as a matter of fact, I am investigating on this subject).  </s>
<s> It might be a bad idea or not, I cannot say at the moment.  </s>
<s> What I know for sure is that it is very easy *now* to point a proxy to another proxy, (e.g. in CERN code) without even thinking of the problem of loops.  </s>
<s> You might not necessarily see the loop immediately, perhaps much later when a particular request triggers the loop.  </s>
<s> Certainly loops would be less frequent and less transient.  </s>
<s> The latter makes the problem perhaps easier to trace, but harder to remove on saturday nights.  </s>
<s> Especially on our side of the ocean, I believe.  </s>
<s> :) this makes me remember our microvax 3500 running an old version of Ultrix (2.1 ?) where the TTL was limited to some low value, and it couldn't communicate with some nodes...  </s>
<s> actually I thought of including the TTL as an additional parameter in the request header, right after the protocol.  </s>
<s> Two motivations are better than one... Luigi Luigi Rizzo Dip.  </s>
<s> di Ingegneria dell'Informazione  </s>
<s> There are also reasons why the Forwarded header can lead to incorrect behaviour in a network of proxies interlinked by long-lived connections.  </s>
<s> There are plenty of cases where forwarding a query on through a proxy though which it has already passed is in fact correct behaviour.  </s>
<s> For example, Suppose we have a network of servers in the following topology 1 2 3 4 5 A----B----C----D----E---F \-----G-------------/ 6 7 Now, lets assume we want to sent a query from A to E. The network topology tells us that we should use link 6 and send the query via G and F  </s>
<s> Suppose however, that in the meantime F crashes, bringing down links 5 and 7. When the query arrives at G, the routing tables will have changed to make the correct next hop A again (A will have updated its tables to route queries to E via B).  </s>
<s> With a Forwarded header, A would be forced to discard the message, even though a path exists between A and E.  </s>
<s> In this case, A should recognize that there is a loop (which is exactly what this scenario describes), cancel the original request, and re-route it to the new destination.  </s>
<s> There is no better way to handle such a request.  </s>
<s> ...Roy T. Fielding Department of Information &amp; Computer Science (fielding@ics.uci.edu)  </s>
<s> Ummm, I thought traceroute just used this hack (useful as it is) because there was no way to change IP to include a "traceroute" command sending a response from each recipient.  </s>
<s> That is why I put TRACE in the HTTP/1.1 specification as a new method.  </s>
<s> The only problem is that you won't get any response back from an unbounded circular route.  </s>
<s> I suppose we could add a Max-Forwards request header, but I'd prefer to have an application test it out first.  </s>
<s> ...Roy T. Fielding Department of Information &amp; Computer Science (fielding@ics.uci.edu)  </s>
<s> Ummm, I thought traceroute just used this hack (useful as it is) because there was no way to change IP to include a "traceroute" command sending a response from each recipient.  </s>
<s> I didn't say that this was the original intent of the TTL field, just that it might well be the main use.  </s>
<s> Evolution works like that :-) But if you were going to design things from scratch to support traceroute, would you come up with a radically different mechanism?  </s>
<s> The "record route" IP header option isn't all that useful.  </s>
<s> Aside from its inability to deal with paths longer than 6 or 7 hops, it only works if the entire path is functioning, and hence cannot be used to find out why a path is not functioning.  </s>
<s> That is why I put TRACE in the HTTP/1.1 specification as a new method.  </s>
<s> The only problem is that you won't get any response back from an unbounded circular route.  </s>
<s> TRACE suffers from the same problem as the IP "record route" option: it's useless if the path is broken.  </s>
<s> (Loops are not the only way to break a forwarding path; it's probably even easier to do that by misconfiguring a "proxy" pointer to point at a black hole.) According to the current 1.1 draft, The TRACE method requests that the server identified by the Request-URI reflect whatever is received back to the client as the entity body of the response.  </s>
<s> This means that (1) the originator of the TRACE method must know the URI of the system that is being asked to reflect the header, and (2) that system must be up and reachable.  </s>
<s> Neither of these things is generally true in the case of a faulty path!  </s>
<s> TRACE seems to be useful for debugging proxies and perhaps clients, but not for determining where a path is entirely broken.  </s>
<s> I suppose we could add a Max-Forwards request header, but I'd prefer to have an application test it out first.  </s>
<s> I think this is an appropriate thing to put into a Proposed Standard.  </s>
<s> We know from experience with traceroute that the basic algorithm is sound and useful.  </s>
<s> On the other hand, we aren't likely to be able to do any realistic testing of the mechanism unless it is supported by popular proxies and perhaps servers.  </s>
<s> And because it is not normal for clients to send it, if it turns out to be a bad idea, we won't have saddled ourselves with a lot of extra baggage.  </s>
<s> In summary, I think we are probably best served by a combination of the proposed mechanisms: TRACE method, useful for debugging implementations, vaguely analogous to ICMP Echo as used in "ping" Max-Forwards: (or TTL:) header, useful for debugging path problems, analogous to IP TTL as used in "traceroute" Forwarded: header, for stopping loops, also useful in conjunction with TRACE, analogous to SMTP "Received:" header Normal requests would carry Forwarded: but not TRACE or Max-Fowards: All servers SHOULD implement TRACE.  </s>
<s> All proxies and servers SHOULD implement Max-Forwards:.  </s>
<s> All proxies SHOULD implement Forwarded:.  </s>
<s> -Jeff  </s>
<s> First, I apologize for jumping into the middle of this thread.  </s>
<s> I'd like to make a couple of comments about how TTL and Forwarded are relevant to the Harvest cache.  </s>
<s> I think that HTTP forwarding loops may become a real problem.  </s>
<s> As we have been getting our six national caches (http://www.nlanr.net/Cache/)  </s>
<s> operational the past few weeks, forwarding loops were unintentionally created due to a bug in the software.  </s>
<s> But I doubt that such bugs will often be the cause of forwarding loops.  </s>
<s> Rather they will be due to configuration errors.  </s>
<s> For now HTTP cache configuration is a fairly manual process, but I doubt it will remain so.  </s>
<s> I can already see the need for a cache to have a default "next hop" with the ability to switch to an alternate next hop if the default becomes unavailable.  </s>
<s> A TTL header would not help Harvest to eliminate loops.  </s>
<s> When the loop is completed and the cache gets a second request for the same URL, this second client-side request becomes "attached" to the first request (on the server-side).  </s>
<s> The caches will deadlock until one of them times out.  </s>
<s> The forwarded header would solve this problem quite easily (except for the hassle of parsing it).  </s>
<s> I totally agree that a HTTP-traceroute will be very useful.  </s>
<s> However, I don't think we need TTL to do it.  </s>
<s> If I understand correctly, traceroute uses increasing TTLs because the IP LSRR option is/was not always implemented, and the fixed IP header size limit only allowed something like nine addresses to be recorded.  </s>
<s> Since HTTP doesn't suffer from either of those problems, wouldn't it be better to just have the Forwarded lines included in the response header?  </s>
<s> Then you only need to make one request.  </s>
<s> Duane W.  </s>
<s> At first I thougt that deadlocks would only occur when a node in the loop finishes it resources (be them connections, processes, whatever).  </s>
<s> I thought that there were *many* of them, so a suitable TTL would avoid deadlocks.  </s>
<s> This looks like the same problem, except that there is exactly *one* resource on each node.  </s>
<s> Convincing arguments!  </s>
<s> Luigi Luigi Rizzo Dip.  </s>
<s> di Ingegneria dell'Informazione  </s>
<s> I totally agree that a HTTP-traceroute will be very useful.  </s>
<s> However, I don't think we need TTL to do it.  </s>
<s> If I understand correctly, traceroute uses increasing TTLs because the IP LSRR option is/was not always implemented, and the fixed IP header size limit only allowed something like nine addresses to be recorded.  </s>
<s> Since HTTP doesn't suffer from either of those problems, wouldn't it be better to just have the Forwarded lines included in the response header?  </s>
<s> Then you only need to make one request.  </s>
<s> Since you jumped into the middle of this thread, you may not have seen the second message I sent on this topic.  </s>
<s> Roy Fielding raised much the same point, to which I replied: TRACE suffers from the same problem as the IP "record route" option: it's useless if the path is broken.  </s>
<s> (Loops are not the only way to break a forwarding path; it's probably even easier to do that by misconfiguring a "proxy" pointer to point at a black hole.) For more details, you can read the whole message as -Jeff  </s>
