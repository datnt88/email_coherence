<s> Apache was recently changed to skip LWS (more specifically, SP and HT) characters between the field name and colon in a HTTP header.  </s>
<s> Previously, Apache would treat this header as having a name including the space character, "Authorization " (!): Authorization : mumble Current versions treat it as a header with name "Authorization".  </s>
<s> This change was made because someone could send a message with a header like that through Apache's proxy, and the proxy would fail to recognise that header.  </s>
<s> This change to Apache raising several questions about the syntax of HTTP headers, particularly as Apache was changed to look for LWS and ignore it there, yet many other servers I have looked at (Squid, thttpd, phttpd, lighttpd) assume a field-name is followed immediately by the colon.  </s>
<s> 1. Is LWS permitted between the field-name and colon?  </s>
<s> The grammar of RFC 2616 suggests that it is, because ":" is a separator character, and thus the rule for implied LWS between a token and a separator applies  </s>
<s> The wording suggests otherwise, although it is not explicit: Each header field consists of a name followed by a colon (":") and the field value.  </s>
<s> Field names are case-insensitive.  </s>
<s> The field value MAY be preceded by any amount of LWS, though a single SP is preferred.  </s>
<s> The wording explicit states LWS is permitted after the colon, suggesting that the intention is that it's not permitted before the colon.  </s>
<s> Many authors have taken that interpretion, resulting in most of the servers I looked at not accepting LWS before the colon.  </s>
<s> (They should probably reject the request, but all of them treat it as an unknown header name including a space in the name token).  </s>
<s> Apache now, and Mozilla, accept LWS at that position.  </s>
<s> 2. What about LWS before the field-name?  </s>
<s> At first sight, this doesn't make sense: LWS at the start of the line indicates folding.  </s>
<s> However, all implementations I looked at accept a line beginning with LWS immediately after the Request-Line or Status-Line.  </s>
<s> Some of them treat the initial LWS as part of the field-name (they don't enforce the limited character range of tokens), or they skip the LWS.  </s>
<s> Apache doesn't look for and ignore LWS prior to the first field-name.  </s>
<s> Neither do Squid, thttpd or lighttpd.  </s>
<s> Mozilla and phttpd do.  </s>
<s> Technically, the grammar disallows LWS before the field-name: Implied LWS is only implied _between_ words and separators.  </s>
<s> Both of these inconsistencies between programs, and also that lone CR is treated as LWS by some and not others, lead to potential security holes due to non-compliant messages that claim to be HTTP/1.1.  </s>
<s> Although it isn't the standard's role to state how a program should respond to every kind of invalid message, it would be good to clarify  </s>
<s> these points because they do have security implications (which was Apache's stated reason for their change):  </s>
<s> 1. Whether LWS is actually permitted between the field-name and colon.  </s>
<s> (Grammar says it is; wording suggests it isn't.  </s>
<s> Implementations vary).  </s>
<s> 2. Whether LWS is actually permitted before the field-name.  </s>
<s> (Grammar says it isn't.  </s>
<s> Implementations vary).  </s>
<s> 3. That lone CR in a line is explicitly not allowed and SHOULD (or MUST?) be rejected, for the specific reason that implementations vary as to whether it is treated as LWS, which has security implications for programs which must match on the field-name.  </s>
<s> 4. That invalid field-names (such as containing control characters or LWS) SHOULD (or MUST?) be rejected.  </s>
<s> Just a few little thoughts.  </s>
<s> The most immediate question is number 1,  </s>
<s> as implementations vary in their interpretation of the standard on that.  </s>
<s> -- JAmie  </s>
<s> generated Apache bug report that caused the change.  </s>
<s> I believe Apache team did the right thing: skipping whitespace  </s>
<s> characters before colon is desirable/correct, and the bug had, albeit  </s>
<s> remote, security implications.  </s>
<s> Yes.  </s>
<s> I believe the wording does not suggest anything beyond what it explicitly says.  </s>
<s> "MAY X" does not imply "MUST NOT Y".  </s>
<s> I hate cases  </s>
<s> where formal grammar is "explained" in semi-formal language, causing doubts and contradiction.  </s>
<s> In this particular case, however, a [less formal] MAY rule does not really contradict the [more formal] grammar.  </s>
<s> The fact that implementations vary does not prove that this wording implies something; there are other, more important, reasons for implementations to vary on the subject.  </s>
<s> Yes, most HTTP servers use ad hoc parsers instead of generating correct parsers for RFC 2616-based grammar.  </s>
<s> You can argue that the implementations in the field are more important than the RFC.  </s>
<s> If you do that, and if you are consistent, many grammar simplifications/changes would be required.  </s>
<s> They should accept the message, ignoring LWS (if any).  </s>
<s> Do you mean SP or HT before the field-name?  </s>
<s> CRLF before the field-name would indicate the end of headers (the field-name would be a part of the body then).  </s>
<s> IMO, documenting behavior on all valid and invalid inputs is what the ideal protocol specification must do.  </s>
<s> It is too late for HTTP, of course.  </s>
<s> IMO: Yes.  </s>
<s> Grammar says it is.  </s>
<s> The wording does not suggest it is not.  </s>
<s> Implementations vary.  </s>
<s> There are probably many special cases here (folding, CRLF, first header, other headers, etc.).  </s>
<s> Implementations vary.  </s>
<s> How does one reject an invalid field-name?  </s>
<s> Do you mean that they should not be forwarded by proxies?  </s>
<s> But a proxy may be (should be?) acting like a tunnel when the message seems to be corrupted.  </s>
<s> Or do you mean origin servers should ignore them?  </s>
<s> But an origin server may be (should be?) acting like a tunnel to CGI-like applications when the message seems to be corrupted.  </s>
<s> I bet that implementations vary with regard to many if not most HTTP/1.1 MUSTs.  </s>
<s> That is, for many MUSTs you can find implementations that violate them under some conditions.  </s>
<s> This is expected given complexity and ambiguity of the standard itself combined with absence of compliance enforcement on top of the "garbage in, compliance out" development spirit.  </s>
<s> Alex.  </s>
<s> Unfortunately, fixing it has introduced new, albeit remote, security implications.  </s>
<s> Previously a Squid proxy or other (old) Apache proxy would have forwarded "Authorization :" and not applied the proxy requirements when that header is forwarded, and the origin server would  </s>
<s> have ignored it.  </s>
<s> The new Apache as origin server will treat it as a proper Authorization header, and may send a response that is inappropriately cached, unknown to the origin server.  </s>
<s> Now that is a remote security implication indeed.  </s>
<s> It's not obvious that you could use it for anything useful, but it's not obvious that you can't, and Authorization isn't the only such header.  </s>
<s> You see?  </s>
<s> It's fixed a bug, and removed one obscure security implication, but replaced it with a new one.  </s>
<s> Given that there are  </s>
<s> more Squid proxies than Apache proxies on a typical path, the new one is marginally more dangerous.  </s>
<s> :)  </s>
<s> I agree.  </s>
<s> That's what I thought when I read the grammar for the first time.  </s>
<s> I agree that there's no contradiction, but I disagree with you about the suggestion of intent.  </s>
<s> Why would the text explicitly mention LWS  </s>
<s> after the colon but nothing about LWS before it, instead of saying,  </s>
<s> with no ambiguity, "the colon may be surrounded by any amount of LWS, though none is preferred before and a single SP is preferred after"?  </s>
<s> "MAY X" does not imply "MUST NOT Y".  </s>
<s> I hate cases  </s>
<s> I agree there is no logical contradiction, however the wording does suggest another rule, precisely because it draws attention to one side of the colon only.  </s>
<s> Importantly, the rule for implied *LWS says "Except where noted otherwise, ...".  </s>
<s> In other words, implied LWS is _only_ implied where the text does not "note otherwise" something else.  </s>
<s> I think this is an example of the text "noting otherwise", even though it does not explicitly say that it is noting otherwise.  </s>
<s> That means there is no logical contradiction with _not_ allowing LWS before the colon.  </s>
<s> Unfortunately, both interpretations fit.  </s>
<s> Sure, but the fact that _all_ implementations I've seen of servers, except for the new Apache behaviour, implement no LWS before the colon strongly indicates that is how people are reading it.  </s>
<s> I know a lot of implementers are sloppy about following the RFC, or have other reasons for ignoring it, but some of the authors are quite conscientious and there is no compatibility problem with writing code which accepts LWS there.  </s>
<s> So we can conclude that authors who were conscientious understood the text to apply, and that it was one of the "Except were noted otherwise" instances of the implied LWS rule.  </s>
<s> I honestly thought the same, until I saw the Apache patch.  </s>
<s> Even though I'd wondered about the implied LWS, I took a guess that the text describing the header syntax is an instance of "noted otherwise".  </s>
<s> And as you know I'm quite conscientiously following the RFC where possible.  </s>
<s> So, I'm saying the standard is ambiguous at that point -- either reading is possible, and a clarification would be good.  </s>
<s> Yes.  </s>
<s> I see one case: the line is non-empty and begins with LWS, either SP or HT. Either it's a folded continuation of the previous line, or it's the line after Request-Line or Status-Line, in which case it's not and grammatically it would match the header syntax if the header syntax permitted LWS before the field-name.  </s>
<s> Implementations do vary, but remarkably few reject this; most accept it as a field-name beginning with LWS! Otherwise skip the LWS.  </s>
<s> Both of these behaviours are bugs, but worse than that: they're both security holes.  </s>
<s> The same kind of hole which motivated your patch to Apache, but through a slightly different route.  </s>
<s> Since they are invalid, the same way one rejects invalid HTTP message syntax: with a 400 response, if no other 4xx is appropriate.  </s>
<s> Proxies and servers alike should reject it, rather than forwarding tunneling it.  </s>
<s> Why? Because passing them along, in either direction, enables the exact remote security exploits which motivated the patch to Apache to allow LWS before the colon.  </s>
<s> There is also the problem of CRs: Apache  </s>
<s> doesn't remove CRs before the colon, but it does treat CR as LWS at other places where tokens are scanned.  </s>
<s> Other clients and servers are different, so there it is plausible that a CR may be used as "LWS" which Apache doesn't trim but something else does.  </s>
<s> Is it not better to reject messages which are clearly out of spec?  </s>
<s> It  </s>
<s> depends whether there are practical reasons to keep forwarding them.  </s>
<s> In the case of control chars and LWS in header names, I think there aren't, but I have not done any surveys to guage it seriously.  </s>
<s> Do you see, that changing Apache in that way, while possibly correct, fixes one obscure security flaw while introducing another.  </s>
<s> Neither behaviour results in a secure server.  </s>
<s> As regards what the spec should say, I suggest it should be unambiguous where appropriate, and it should lead the way in indicating how servers SHOULD reject certain constructs for security reasons, even if it will be a long time, if ever, before the recommendations are actually widespread among implementations.  </s>
<s> Presently I find the syntax of headers is ambiguously presented, precisely because you can understand the text is an instance of the "except where noted otherwise" clause for implied *LWS, or you cannot.  </s>
<s> Both interpretations make sense linguistically to me, and even if I'm wrong, it indicates clearer text is appropriate.  </s>
<s> And, even though the syntax does not allow control characters or lone CRs in headers, and probably does not allow LWS before the field-name of the first header line, it would be good for the RFC to suggest a policy among implementations, of making a point of rejecting those.  </s>
<s> Without guidance from the RFC, implementors will do exactly what they are doing: copy each other, and do the simplest in the belief that real web servers have to do that sort of thing to be robust in the real world.  </s>
<s> Perhaps they do, perhaps they don't, but most implementors will take into account guidance from the RFC and other related documents, if it is available.  </s>
<s> I think it's reasonable for the RFC to suggest implementation SHOULD reject such headers, instead of letting the implementor make an  </s>
<s> unguided decision, because it is easy, probably not harmful (this should be checked empirically of course), and prevents a number of theoretical and subtle security flaws due to different programs having different interpretations of non-compliant header names.  </s>
<s> This is different from a blanket suggestion to reject all invalid syntax: it's not reasonable for the RFC to suggest implementations reject field _values_ which don't match the grammar.  </s>
<s> That is likely to break real setups.  </s>
<s> The former is a good in real life (I am guessing; maybe something really depends on it); the latter is not, and the RFC may as well say so.  </s>
<s> Fwiw, my implementation strategy is to read the RFC and related RFCs, and to read the code for a number of servers and clients in order to figure out in what ways deviation from the RFC or extra rules are needed for the real world.  </s>
<s> Unfortunately, there's no way to determine whether an implementation quirk that lots of programs have in common is needed for the real world, or just like that for other reasons, like everyone copying each other, or it being an obvious ad-hoc implementation method.  </s>
<s> -- JAmie  </s>
<s> Oof! And my old code may even be responsible for the Squid parsing bug!  </s>
<s> :-/  </s>
<s> There is no "new" bug if you consider that there are origin servers other than Apache out there and that some of them might be compliant in this parsing aspect.  </s>
<s> It looks like to avoid compatibility problems with broken proxies, Apache origin server should not authenticate based on valid but "difficult to parse" Authentication header.  </s>
<s> Because that is the way RFC 2616 and most other RFCs are written: Prose text comments on typical use cases or known compatibility issues.  </s>
<s> Formal grammars are supposed to cover everything.  </s>
<s> This is not how most RFCs are read and implemented, unfortunately.  </s>
<s> Please remember this if you happen to write an RFC :-)  </s>
<s> Agreed: A clarification would be good.  </s>
<s> Please submit an errata.  </s>
<s> A short errata may help to engage HTTP authors/gurus that are most likely ignoring these long messages.  </s>
<s> IMO, SP or HT before non-first header is line folding and should be interpreted as such.  </s>
<s> SP or HT before the first header is a malformed message that should be rejected.  </s>
<s> Indeed!  </s>
<s> I think I agree.  </s>
<s> At least, I am glad that there is a security issue (albeit a remote one) that illustrates why implementing specs by looking at examples is dangerous.  </s>
<s> In an ideal world, yes.  </s>
<s> The common interpretation of IETF philosophy to convert garbage input into compliant output and the (related) real world demands do not allow that kind of purity, at least not for HTTP.  </s>
<s> I am sure that new restrictions will break some old implementations.  </s>
<s> HTTP has been around for too long.  </s>
<s> Since the real issue here is security, perhaps the errata should simply explain why using Authorization header-based authentication is a bad idea, regardless of the header value.  </s>
<s> We now have SSL/TLS instead (with their own security flaws :).  </s>
<s> Alex.  </s>
<s> How do I submit errata?  </s>
<s> The errata page says to join this list.  </s>
<s> Well, I did, I asked some questions and got this far.  </s>
<s> What is the next step?  </s>
<s> -- Jamie  </s>
<s> AFAIK, IETF does not have a formal mechanism for submitting errata.  </s>
<s> Just post a concise e-mail, one for each error, suggesting specific RFC text changes.  </s>
<s> With some luck, your changes will be propagated to the official errata page and to the next revision of the protocol specs.  </s>
<s> Alex.  </s>
<s> I think the errata in question is hinted at in  </s>
<s> but it would be nice to write up a summary of how the spec should actually change, so that we can judge 'consensus' on the proposed text.  </s>
<s> Note that Scott Lawrence maintains a HTTP errata page at http://purl.org/NET/http-errata  </s>
<s> To report suspected errors that are more technical in nature, please verify the errors with the authors and/or appropriate area directors of the IESG before sending them to the RFC Editor for posting.  </s>
<s> In this case, though, we got the RFC editor to point to Scott's page.  </s>
<s> Jim Gettys claims that draft-gettys-http-v11-spec-rev-00.txt already includes all of the existing errata, so, once there is clear agreement, the change could also be incorporated.  </s>
<s> Larry  </s>
<s> That's one of them.  </s>
<s> (Despite the subject of that message, that specific message is about 100 Continue and when to send it).  </s>
<s> The others are: 2. Clarification of whether LWS is permitted before the colon in headers.  </s>
<s> Various people understand the RFC differently, as can be seen in their implementations.  </s>
<s> 3. Require agents to reject messages with malformed field names, and perhaps field names which have LWS before the colon, because not doing so leaves open certain security holes due to proxies and other intermediate agents not recognising or filtering headers that are interpreted by another agent.  </s>
<s> Notably, headers with LWS _before_ the field name should be rejected.  </s>
<s> (Yes, certain widely used software treats it as part of the name when it's the first header line, instead of as a continuation line, and other widely used software skips the LWS there).  </s>
<s> If LWS is not permitted before the colon, messages with that should be reject as well.  </s>
<s> (Even if it's decided that RFC2616 permits LWS there, in my opinion it makes sense to decide that LWS should not be permitted there, and require implementations to reject any message which has it.  </s>
<s> Nobody sends messages with LWS there (because most agents don't accept it), and rejecting it closes a potential security hole.  </s>
<s> Note that rejecting it is different from Apache's old behavior, which was to accept LWS there and treat it as part of the field name, thus passing along a dangerous name through it's proxy).  </s>
<s> 4. Suggest agents reject messages with CR in any part of the header, except as part of the CR NL sequence.  </s>
<s> Again potential security holes: some proxies split lines on any of CR, NL or CR NL. Working around deployed bugs yes, but the implementation suggestions may as well recommend this.  </s>
<s> Practical implementation issue: NL CR CR NL is known to end the headers from some very old servers, so robust clients accept it and this is documented in a few places.  </s>
<s> Not sure if CR CR NL has been used to end non-empty header lines, but it's easy to see how this could arise, from quirky CGI implementations.  </s>
<s> 5. Clarification as to whether it's ok to send any part of a response before reading all of the request body and whether a client should accept that.  </s>
<s> The RFC text _seems_ to indicate that this should work, for non-"error status" responses only, with complient agents.  </s>
<s> But I may have misunderstood it, and there's no doubt that some implementors have misunderstood or ignored section 8.2.2.  </s>
<s> This is potentially useful for a server which does on-the-fly translation of a submitted request: the streamed request could be translated on-the-fly to a streamed response.  </s>
<s> This is potentially useful even for web browsers, hence the reason for testing against those.  </s>
<s> This also has other streaming uses: using an HTTP request-response pair as a substrate for another bidirectional protocol, temporarily.  </s>
<s> Tests with many clients indicate that its ok with most of them, and some clients accept the response while continuing to stream the request, while others stream the whole request before accepting the response, so servers must be prepared to keep reading the request even when response writing blocks (to prevent deadlock).  </s>
<s> If the server does that, for all of these clients this method can be used.  </s>
<s> However, I saw failure with Mozilla 1.2, which seems to abort the request on seeing part of the response even if it's 200 OK, but I did not have enough time to investigate properly.  </s>
<s> Didn't try any version of MSIE.  </s>
<s> It would be good to know whether this is ok (a) in theory according to the standard; (b) in practice.  </s>
<s> The RFC errata should at least clarify (a).  </s>
<s> 6.  </s>
<s> What is the definiton of "error response" as used in section 8.2.2.  </s>
<s> It may be that the words "error response" will be deleted in order to clarify point 5 above, which would make point 6 moot.  </s>
<s> -- Jamie  </s>
<s> Jamie, As suggested by Larry and myself, it is probably time for you to post specific, concise changes to RFC 2616.  </s>
<s> After a discussion, some or all of those changes can be incorporated into RFC errata.  </s>
<s> We have discussed these issues.  </s>
<s> Some of them seem pretty straightforward specification bugs, some may be less appropriate for an errata.  </s>
<s> Hopefully, this semi-idle group would be able to come to rough consensus once you post specific changes.  </s>
<s> If not, you can always try to contact IETF IESG directly, but, again, you will need specific changes written up and discussed here first.  </s>
<s> Please post specific errata, how you want it to appear on the official errata page.  </s>
<s> Dedicating a single e-mail subject/thread to each change you post may be a good idea.  </s>
<s> Thank you, Alex.  </s>
