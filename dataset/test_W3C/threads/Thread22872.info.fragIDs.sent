<s> Hi w3c dom people,  </s>
<s> As a result of a conversation between Philippe Le Hegaret, Tim Janik, and myself yesterday, I am sending this mail to propose a change in the semantics of removeEventHandler.  </s>
<s> Briefly, the current semantics call for the handler to be invoked in some cases after it is removed.  </s>
<s> I propose that it should not be.  </s>
<s> Let me start by outlining a concrete example.  </s>
<s> Suppose the document contains an "X" button that is intended to hide one of the elements of the document.  </s>
<s> Further suppose that there is a Model/View/Controller architecture with the DOM as the Model, and separate View and Controller modules that are connected via the DOM event mechanism.  </s>
<s> Thus, both the Controller and the View have listeners on the button.  </s>
<s> The Controller listener implements the semantics of removing the object, while the View listener keeps the display up to date, including (in this example) visualizing mouse events.  </s>
<s> Then, the following sequence is at least plausible: The user clicks on the "X".  </s>
<s> The Controller event listener is invoked first, which performs the operations needed to hide the object.  </s>
<s> In particular, it detaches the View from the element, changing the View state so that the element is no longer shown, and invoking removeEventListener on the View's handlers.  </s>
<s> Finally, the Controller's event handler completes, and the DOM invokes the event listener of the View.  </s>
<s> However, the View's state is no longer consistent with the element being shown.  </s>
<s> Thus, unless the View takes special care to detect the fact that the event should no longer be handled, unexpected behavior is likely.  </s>
<s> Note that this unexpected behavior is quite dependent on the order  </s>
<s> of invocation of the handlers on an element.  </s>
<s> If the View's handler is  </s>
<s> invoked first, nothing bad will happen.  </s>
<s> The Gtk+ signal mechanism is quite analogous to DOM2 Events, and is extensively used for plumbing UI events, as might be expected from advanced usage of the DOM.  </s>
<s> Tim Janik, a long time co-maintainer of Gtk+, has collected quite a bit of experience in this area, particularly in dealing with re-entrant invocations and similar interactions.  </s>
<s> His experience is that invoking a handler after removal nearly always contains the possibility of unexpected behavior, and is rarely (if ever) actually useful.  </s>
<s> Gtk+'s signal mechanism currently enforces the invariant that a handler is never invoked after removal, and these semantics work quite well in practice.  </s>
<s> For more information on Gtk+, please refer to the Gtk+ webpage at After discussing the issues with Tim and Philippe, I believe that the current DOM semantics may well cause real problems in Gill, as I expect that quite a lot of functionality might be invoked from event listeners, including modifications to the relationship between the Model and the View.  </s>
<s> Gill is the Gnome implementation of SVG, a spec in preparation by the W3C for advanced graphics.  </s>
<s> Gill is based on a strict Model/View/Controller architecture based on the DOM, and the consistency between Model and View is maintained entirely from DOM2 Events.  </s>
<s> The Gill webpage is at http://www.levien.com/svg/  </s>
<s> Thus, I propose the following modification to the specification.  </s>
<s> The current language in the description of removeEventListener reads: "If an EventListener is removed from an EventTarget which is currently processing an event the removed listener will still be triggered by the current event."  </s>
<s> This should be changed to read "will not be triggered by the current event".  </s>
<s> Further, the statement, "an event listener will never be invoked after it is removed" should be added as a global invariant.  </s>
<s> I believe that the pain of making this change now is insignificant to that of changing the semantics in a later DOM level.  </s>
<s> I advocate making the change now, before the status advances past Candidate Recommendation.  </s>
<s> Thanks in advance for considering this issue.  </s>
<s> Raph  </s>
<s> Understood, and quite reasonable.  </s>
<s> Are you sure you like not knowing whether the removal will occur before or after invocation better than you like knowing that it won't?  </s>
<s> I don't understand this.  </s>
<s> I prefer knowing that the removal suppresses subsequent invocation of the handler being removed, even if there is an event pending for that handler.  </s>
<s> I'm not sure that corresponds exactly to either of your preferences.  </s>
<s> (_I_ prefer the uncertainty because it may simplify my DOM implementation.  </s>
<s> I'm not sure that folks who are actually trying to use the DOM will agree.)  </s>
<s> Is your DOM implementation Xerces-J?  </s>
<s> Timj, Philippe, and I looked at this code at the time we discussed the change, and believe that the change can be implemented with a dozen line patch.  </s>
<s> To do it roughly  </s>
<s> analogously to Gtk+, you keep a reference counter in the data structure you use to hold the listener (not having the source in front of me at the moment, the name escapes me).  </s>
<s> It is initially 1, incremented before invoking the listeners on an EventTarget, and decremented afterwards.  </s>
<s> To implement removeEventListener, you invalidate the listener (for example, by setting the "type" to null) and decrement the reference count.  </s>
<s> At the time the reference count becomes zero, it is removed from the list.  </s>
<s> This technique may add a small bit of complexity, but I don't see it as being decisive.  </s>
<s> 2) You've only proposed a change to removeEventHandler.  </s>
<s> What about addEventHandler on the active EventTarget -- does that also become unspecified in its timing, rather than taking effect only after this phase ends?  </s>
<s> I would expect so, for symmetry.  </s>
<s> Actually, I like the existing semantics.  </s>
<s> You generally add an event handler when creating a new View.  </s>
<s> Usually, the state of the View is initialized to be consistent.  </s>
<s> So, as long as the Controller creates the new Views after updating the state of the Model, you're fine.  </s>
<s> What about the opposite order.  </s>
<s> The View's listener fires, doesn't know that the event should no longer be shown, delivers your "unexpected behavior"... and only then does the Controller's listener fire and realize that the element can be hidden.  </s>
<s> I disagree here.  </s>
<s> For the View's listener to fire while the View is still in the state of showing the element should be fine.  </s>
<s> It should be pretty much the same behavior as if you had two events in sequence - the first event updates the View (for example, by unhighlighting a clicked button), while the second removes it.  </s>
<s> A little more drawing than strictly necessary, perhaps, but not "unexpected behavior".  </s>
<s> And you may not realize that this requirement exists until you ship your code and someone runs it on a different DOM.  </s>
<s> Well, this is my concern.  </s>
<s> Since the order is unspecified, we should be careful not to create the situation where "it works for me" but displays subtle and nasty bugs when ported.  </s>
<s> I took a quick look at this.  </s>
<s> It's not very clear, but if I'm reading it correctly, Gtk+'s event listeners are ordered.  </s>
<s> "As stated above, you may have as many callbacks per signal and per object as you need, and each will be executed in turn, in the order they were attached."  </s>
<s> (With some issues of adding them before/after the default handler; there are two separate calls to access those two spaces.)  </s>
<s> In that scenario, the scenario described above makes more sense; you can talk about one listener reliably preceeding another, and thus ordered cancellation or removal.  </s>
<s> Well, Gtk+ is more deterministic than DOM in this way, but that's not really the issue.  </s>
<s> I am talking about making it easier to write code that does the right thing with any ordering.  </s>
<s> If that's the goal, it may be a reasonable one... but it's a much larger change than simply changing removeEventListener in isolation.  </s>
<s> I am not proposing to change the nondeterminism of invoking event listeners.  </s>
<s> Our current design says that if you care about the ordering of listeners, it's your responsibility to build and register a listener which dispatches to other listeners in the desired order, and register your order-sensitive listeners with that rather than directly on the DOM.  </s>
<s> Understood.  </s>
<s> But my motivations here are strictly to make it easier to write code which does _not_ care about the ordering of listeners.  </s>
<s> I hope this clears up my position.  </s>
<s> Please feel free to ask if not.  </s>
<s> Raph  </s>
<s> Well, I always found its current specification to be a bit strange, in part because it was unmotivated.  </s>
<s> Before changing it I'd like to hear the rationale: why was it originally specified that way?  </s>
<s> Use cases motivating the current behavior would be a good start.  </s>
<s> There's also the "add a listener" case too ... basically it's now set up so that event delivery should snapshot the listeners that will be called for targets at each level of event dispatch.  </s>
<s> If the spec were to change (not something I tend to want in this area) then the "add a listener" case needs to be addressed too.  </s>
<s> - Dave  </s>
<s> I believe that the intent was to make the set of Event listeners invoked be independent of the order that the events are delivered.  </s>
<s> The order of delivery is left undefined by the specification.  </s>
<s> -- Andy  </s>
<s> Quoth Raph, responding to me:  </s>
<s> Are you sure you like not knowing whether the removal will occur before  </s>
<s> or  </s>
<s> after invocation better than you like knowing that it won't?  </s>
<s> My point was that while this orders the operations of removal and invocation, you still have no way to control the order of event handlers, and so the question of whether the handler is or isn't invoked is still indeterminate.  </s>
<s> I see your point about synchronizing the removal (whenever it does occur) with other work related to that removal, and why you'd like the DOM to handle that for you rather than your having to maintain a flag of some sort.  </s>
<s> As I said: Changing the DOM implementation to handle this might be too bad.  </s>
<s> I'm still not sure it's a better behavior for the average DOM-based application; that's my main point of concern.  </s>
<s> Introducing asymmetry between the add and remove behaviors bothers me somewhat.  </s>
<s> (I'm not sure I'm following your reference-count proposal for implementation; I don't quite see why the count is necessary.  </s>
<s> I assume I'm missing something obvious.) Joe Kesselman / IBM Research  </s>
