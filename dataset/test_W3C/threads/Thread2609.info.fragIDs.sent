<s> Here are some comments on the draft-ietf-tls-http-upgrade-01.txt draft.  </s>
<s> First, I would like to say that I think it is crucial to the integrity of  </s>
<s> the Web that it become possible to negotiate transport stacks dynamically instead of using new URI schemes.  </s>
<s> Now to the comments:  </s>
<s> * Chapter 5.1: There is no link between the use of the Upgrade header field  </s>
<s> and the cachability of a response as you indicate in the second last paragraph.  </s>
<s> Upgrade is optional and it is fully ok for a cache to serve an  </s>
<s> already cached HTTP response either using HTTP or HTTP/TLS (if the cache  </s>
<s> chooses to honor the Upgrade header field).  </s>
<s> Obviously, it is not OK to do  </s>
<s> it the other way.  </s>
<s> If the client starts with an OPTIONS request and the cache honors the upgrade request, subsequent requests on that secure connection must of course be served on top of the same secure connection.  </s>
<s> * Chapter 7: Saying that the protocol is HTTP doesn't say a whole lot more about the service than saying that it is TLS.  </s>
<s> More importantly, the Upgrade header field is also intended to upgrade HTTP  </s>
<s> itself, for example from HTTP/1.1 to some future HTTP/3.0.  </s>
<s> However, when you collapse HTTP and TLS into one token, you loose the capability (or run into a multiplicative explosion) expressing that the application would like  </s>
<s> to upgrade to both HTTP/3.0 *and* TLS/1.0.  </s>
<s> Instead it is more useful to do it like this: Upgrade: HTTP/3.0, TLS/1.0  </s>
<s> In other words, there is no need for the "clustering" of Upgrade header field tokens.  </s>
<s> A general problem with the Upgrade header field tokens is, however, that they do not allow for parameters to be passed along: How do I specify other  </s>
<s> parameters such as required encryption strength, the scope of resources available through that secure link, etc?  </s>
<s> It should not be part of the extension mechanism to describe such parameters directly but it must be possible for the application to at least pass that information through.  </s>
<s> * Chapter 9: There is no guarantee that "http://w3.org" and "https://w3.org"  </s>
<s> point to the same resource just as well as there is no guarantee that "ftp://w3.org" and "http://w3.org" point to the same  </s>
<s> resource.  </s>
<s> In general, it is not possible to declare that the http namespace  </s>
<s> can take over the https namespace as you write in chapter 9.  </s>
<s> What instead you *can* do is to provide a mechanism for making http: URIs secure and for resolving https: URIs using HTTP just as well as ftp: URIs can be resolved using an HTTP gateway.  </s>
<s> * I think there is a problem with the OPTIONS method and how you specify that it should interact with the upgrade header field.  </s>
<s> The OPTIONS request  </s>
<s> can be forwarded all the way to the origin server as described in HTTP/1.1  </s>
<s> section 5.1.2.  </s>
<s> However, the Upgrade header field can't (which you also point out) as it is a hop-by-hop header field.  </s>
<s> For example, the user agent sends an OPTIONS request like this: OPTIONS http://w3.org  </s>
<s> HTTP/1.1 Upgrade : HTTP+TLS/1.0 Connection: Upgrade  </s>
<s> this will be forwarded through the first proxy as  </s>
<s> OPTIONS http://w3.org  </s>
<s> HTTP/1.1 or OPTIONS * HTTP/1.1 Host: w3.org Note that the proxy hasn't agreed on tunnelling yet - it has only forwarded the request according to normal HTTP/1.1 rules.  </s>
<s> If the user agent instead sends a request like this: OPTIONS * HTTP/1.1 Host: w3.org Upgrade : HTTP+TLS/1.0 Connection: Upgrade then the request is intended for the proxy only (in the role as a server) and won't get forwarded.  </s>
<s> In order for the proxy to forward the request for  </s>
<s> a tunnel, it must itself send a new OPTIONS * request which isn't sent on behalf of the user agent but of the proxy because the two OPTIONS * requests (the one from the user agent and the one from the proxy) are not related in any way.  </s>
<s> I believe the intended semantics (I call it "repeated hop-by-hop") can be modelled by the HTTP extension framework like this (and is sort of the idea of the CONNECT draft [1]): M-OPTIONS http://w3.org  </s>
<s> HTTP/1.1 Host: w3.org Man: "http://www.iana.org/http/ext/tls"  </s>
<s> This request will be tunneled through the proxy because it doesn't know the  </s>
<s> extension (or if it does then it will know what it must tunnel), or it will  </s>
<s> fail and refuse to cooperate (which also is the case for the OPTIONS method).  </s>
<s> As the extension is not hop-by-hop, it will be forwarded all the way to the ultimate recipient.  </s>
<s> The response could of course still be a 101 Switching Protocols which would  </s>
<s> then be propagated all the way back to the user agent and all intermediaries will already be in tunnel mode.  </s>
<s> Furthermore the extension framework would allow for additional parameters to be sent in the request, like for example the required key length etc: M-OPTIONS http://w3.org  </s>
<s> HTTP/1.1 Host: w3.org Man: "http://www.iana.org/http/ext/tls";  </s>
<s> ns=65 65-keylength: 128 Something to consider, Henrik  </s>
<s> ps: Reference 7 ([7]) doesn't seem to be used anywhere  </s>
<s> [1] xt.html Henrik Frystyk Nielsen, World Wide Web Consortium  </s>
<s> We'll accept that as a supporting comment :-)  </s>
<s> field  </s>
<s> I believe that you are referring to: Furthermore a caching proxy SHOULD not reply to a request with Upgrade tokens from its cache.  </s>
<s> The intent here is just to remind the proxy that Upgrade, as a  </s>
<s> hop-by-hop header, is not appropriate to cache with a response and forward as part of that response; it is not a property of the returned entity, but of the immediate (in this case origin-proxy) connection.  </s>
<s> The rules that govern what happens after any upgrade are those of the protocol to which the connection has changed, and are therefor beyond the scope of this document.  </s>
<s> HTTP  </s>
<s> like  </s>
<s> We considered this alternative at some length, and at one point had written the draft that way.  </s>
<s> We liked the idea of the Upgrade response header being able to specify a series of protocol tokens so as to specify a stack to be used after the change.  </s>
<s> We were not sure that  </s>
<s> this would be understood, however.  </s>
<s> RFC 2616 is vague on just what  </s>
<s> multiple tokens could mean in an Upgrade response.  </s>
<s> We elected for the simpler set of expectations.  </s>
<s> other  </s>
<s> The syntax just doesn't have a space for it (for some reason, even the usual extension mechanism of 'stuff after a semicolon' was omitted from the Upgrade syntax).  </s>
<s> In any event, TLS provides for negotiation of these parameters directly; I suspect that leaving option negotiation to the protocol to which we are switching (as opposed to trying to shortcut it by doing it in HTTP) is the better approach.  </s>
<s> namespace  </s>
<s> It was not our intent to redefine the 'https' scheme, or to suggest that implementations should somehow map it to this new mechanism.  </s>
<s> That scheme exists and will forever mean HTTP over SSL on TCP port  </s>
<s> 443.  </s>
<s> From the reactions we got, we were evidently not successful at making this clear.  </s>
<s> I'm not sure that I agree with your interpretation of this latter formulation - I think that they are both the same, but I'm afraid that I do agree with your conclusion that the Upgrade header should not be forwarded, which causes some problems with what we suggest as an end-to-end solution.  </s>
<s> It would require, in effect, that the user agent understand the entire proxy chain and do a series of OPTIONS/Upgrade requests to create secure connections through each individually (not an optimal solution, IMHO).  </s>
<s> I wonder what existing proxies really do with Upgrade; in particular: - Do they in fact forward it (incorrectly?) in a response if it is _not_ (incorrectly) listed in a Connection header?  </s>
<s> - Whether or not they react to it in a 101 response (our draft would have them switch to tunnel mode - what do they do today)?  </s>
<s> the  </s>
<s> will  </s>
<s> That is still a change to an existing proxy, though - because it requires that the proxy conform to the extensions draft.  </s>
<s> I agree that would be a good thing, but I don't think that it changes our situation at all now.  </s>
<s> would  </s>
<s> But will they be expecting to stay there for all subsequent requests, or will they just switch to tunnel mode for the current request and then expect to be 1.1 again afterwards?  </s>
<s> We didn't put the marker in - it is in the acknowledgements; will fix in the next go 'round.  </s>
<s> Scott Lawrence Director of R &amp; D lawrence@agranat.com  </s>
<s> Agranat Systems, Inc. Embedded Web Technology http://www.agranat.com/  </s>
<s> I was referring to this in 5.1: Furthermore a caching proxy SHOULD not reply to a request with Upgrade tokens from its cache.  </s>
<s> Clients are still advised to explicitly include "Cache-control: no-cache" in this case.  </s>
<s> which seems to say something else (which in fact is not true) - see below.  </s>
<s> In general yes, but you are not dealing with the general case - you are describing the very specific case of changing from HTTP on TCP to HTTP on SSL.  </s>
<s> I think you have to describe how responses that have been obtained via HTTP can be reused by caches after proper end-to-end validation and served via HTTP/SSL.  </s>
<s> Unfortunately this leads easily to an explosion of tokens that have to be registered.  </s>
<s> HTTP doesn't have to say anything about the relationship between the various tokens in the upgrade header field.  </s>
<s> It is sufficient for the protocols (or sub protocols) independently to define how they can interact with other protocols.  </s>
<s> For example, it can be stated in the  </s>
<s> registration of the SSL upgrade token that it can work with any version of HTTP.  </s>
<s> It is not a short cut - it is an exchange of hints (metadata) which can put  </s>
<s> the recipient in a better position to select the best choice.  </s>
<s> It would be a  </s>
<s> short cut if it was binding for what happens after the upgrade is done - it is not.  </s>
<s> ok  </s>
<s> Nope, a proxy would regardless of whether it knows HTTP extension framework or not dive into tunnel mode or return a 501 (Not Implemented).  </s>
<s> Similarly, an optional extension would be passed through to the end: OPTIONS http://w3.org  </s>
<s> HTTP/1.1 Host: w3.org Opt: "http://www.iana.org/http/ext/tls"  </s>
<s> It would work even with proxies that don't support the extension framework.  </s>
<s> Once a proxy agrees to tunnel, it does not take part of the HTTP communication and stays in tunnel mode until both transport connections have been closed, see 1.2: tunnel An intermediary program which is acting as a blind relay between two connections.  </s>
<s> Once active, a tunnel is not considered a party to the HTTP communication, though the tunnel may have been initiated by an HTTP request.  </s>
<s> The tunnel ceases to exist when both ends of the relayed connections are closed.  </s>
<s> There is actually a bug here - the 101 (Switching Protocol) status code is passed though proxies (and-to-end) while the Upgrade header field it is responding to is hop-by-hop.  </s>
<s> This means that a client behind a proxy will get the 101 response even though it hasn't asked for an upgrade but the proxy did.  </s>
<s> It should be mentioned that 101 (Switching Protocols) shouldn't be forwarded by proxies if not tunnelling.  </s>
<s> In 5.1, you mention that a proxy receiving a 101 should tunnel but this does not work if the proxy initiated the Upgrade header field by itself.  </s>
<s> The HTTP extension framework solves this problem by having the Ext: and C-Ext: header fields to indicate who accepted an extension.  </s>
<s> Henrik Henrik Frystyk Nielsen, World Wide Web Consortium  </s>
<s> I agree with Henrik.  </s>
<s> And I don't see anything vague about the definition of Upgrade in RFC 2616 -- the answer to this question is in the very first sentence.  </s>
<s> As for using the extension stuff, Upgrade is intended to be a simple switching mechanism for the immediate connection, in contrast to the various general extension mechanisms.  </s>
<s> The two may or may not be used in tandem, or separately, but must not be co-dependent in their definition.  </s>
<s> Upgrade uses only the protocol tokens --- all further negotiation is postponed until after the protocol is switched.  </s>
<s> Anything more complex than that can and should be accomplished via the extension mechanism, though I have yet to see any real need for further complexity which wasn't better accomplished by an extra round-trip -- complex things should not expect to be as efficient as simple things.  </s>
<s> 101 is not passed through proxies.  </s>
<s> Section 10.1 excludes 1xx responses that were requested by the proxy, as would be the case here.  </s>
<s> Actually, a tunnel is never a proxy, even if it was a proxy at some time in the past.  </s>
<s> The spec needs to be consistent in defining requirements only in terms of the role of the application at the time of its communication for that request/response.  </s>
<s> Otherwise we would have to place five exceptions after every requirement.  </s>
<s> ....Roy  </s>
<s> [I've split my responses into two - one to address the upgrade tokens question and another to respond to proxy issues -SDL]  </s>
<s> From: Roy T. Fielding Subject: Re: Comments on HTTP TLS Upgrade draft  </s>
<s> Henrik says:  </s>
<s> While I prefer having the Upgrade response indicate an ordered list specifying the stack, I don't agree that HTTP doesn't have to say anything.  </s>
<s> If I specify: Upgrade: CompressLayer/1.0, MuxLayer/1.1, HTTP/1.1 it certainly isn't the same as: Upgrade: MuxLayer/1.1, CompressLayer/1.0, HTTP/1.1 and the client needs to know which I mean.  </s>
<s> This is a difference between the usage (as I understand it) of the Upgrade header in a request and a response - the request doesn't specify a stack, it specifies a set of choices (without indicating which combinations are possible - a problem, I think), but in a response it specifies an ordered stack.  </s>
<s> I actually prefer the multiple-token solution, myself.  </s>
<s> One point I thought would cause confusion was the sentence (from 2616#14.42):  </s>
<s> The Upgrade header field only applies to switching application-layer protocols upon the existing transport-layer connection.  </s>
<s> We are actually using it to insert a new layer into the stack, not change the application layer protocol (indeed, in the IPP case we are treating both TLS and HTTP as session layer protocols, but...).  </s>
<s> I agree, which is why I didn't want to include even hints in the upgrade response about TLS/SSL options.  </s>
<s> I'm perfectly happy to change the text back to a multiple-token rather than combined-token [Rohit?].  </s>
<s> Scott Lawrence Director of R &amp; D lawrence@agranat.com  </s>
<s> Agranat Systems, Inc. Embedded Web Technology http://www.agranat.com/  </s>
<s> I think the experience from the current use of User-Agent shows that people in practice tends to overload simple tokens with as much information as possible.  </s>
<s> Although it is slightly different from the Upgrade header field tokens, the exchange of metadata about the communication should be light weight and not necessarily cost an extra RTT.  </s>
<s> Solving this using first class objects is much to be preferred - hence the push for HTTP extension framework.  </s>
<s> Duh - I was looking at draft 07 where it wasn't mentioned.  </s>
<s> I am glad it is now.  </s>
<s> I agree - it was the point in the draft about transition from proxy to tunnel that I was objecting against.  </s>
<s> Henrik Henrik Frystyk Nielsen, World Wide Web Consortium  </s>
