<s> The removeEventListener method insists that EventListeners not be triggered after they have been removed (natrually) even if they are removed while the current list (of which the removed EventListener was a member) is still being processed.  </s>
<s> "If an EventListener is removed from an EventTarget while it is processing an event, it will not be triggered by the current actions.  </s>
<s> EventListeners can never be invoked after being removed."  </s>
<s> Implementation-wise this presents a bit of a problem.  </s>
<s> If you use a linked list for your listeners and the element you are currently iterating over is removed (the listener removed itself) then you will dereference an invalid pointer trying to get the next node.  </s>
<s> If you make a copy, a listener may be triggered after it has been removed.  </s>
<s> The only solution I have at the moment is to make a copy just prior to triggering the list in dispatchEvent _but also_ check with the live list just before triggering each listener to make sure they have not been removed.  </s>
<s> IOW, only if the listener is in both the live list and the copy should it be triggered.  </s>
<s> Of course checking the live with each invocation of a listener would suggest arrays are used.  </s>
<s> Is this true or did I miss something?  </s>
<s> Xerces-J 1.4.2 looks like it falls into the 'make a copy and potentially trigger a listener that has been removed' category but I'm not terribly familiar with that code.  </s>
<s> I don't know about Xerces-C either -- the download was a little much for my home connection.  </s>
<s> Mike Wow a memory-mapped fork bomb!  </s>
<s> Now what on earth did you expect?  </s>
<s> - lkml  </s>
<s> This was discussed just a little while ago in a thread primarily on the xerces-j-dev list but with a few messages cc'd here.  </s>
<s> Particularly, this issue.  </s>
<s> The current implementation of Xerces-J can dispatch events to a listener that has been removed.  </s>
<s> This shows up in one of my personal DOM Events tests that are part of domunit (part of the http://xmlconf.sourceforge.net  </s>
<s> project) that I anticipate donating to the W3C/NIST DOM testing effort when we get to Level 2.  </s>
<s> In the following passage, my original statement is preceded by  </s>
<s> The third test checks removing an event listener in the middle of an event dispatch sequence.  </s>
<s> The spec says that a listener should recieve no events after removal.  </s>
<s> You're right there, that's what the spec currently says.  </s>
<s> But the spec is wrong, though.  </s>
<s> It is meant to say the opposite.  </s>
<s> I just double-checked with Joe Kesselman who was very much involved in the development of that spec and who implemented it in Xerces and he confirmed my fears.  </s>
<s> I will bring it up to the DOM Working Group, I would expect an erratum to be published.  </s>
<s> Xerces-C does not have an Events implementation currently and I don't know of any plans to add one.  </s>
<s> I'm not either a W3C or DOM WG member or a Xerces committer, so nothing here is definitive, but I believe that it is reasonably correct.  </s>
<s> You're right there, that's what the spec currently says.  </s>
<s> But the spec is wrong, though.  </s>
<s> It is meant to say the opposite.  </s>
<s> Meaning an EventListener should be called even if another listener in the list currently being processed removes it?  </s>
<s> I think the implementation  </s>
<s> issue may become even more difficult in languanges with explicit memory management though.  </s>
<s> Currently, my implementation frees a ListenerEntry struct when removeEventListener is called.  </s>
<s> As is, this would result in dereferencing a dangling pointer if dispatchEvent attempts to trigger a  </s>
<s> listener after it has been removed.  </s>
<s> I suspect I must collect the pointers to the actull functions to be called for each listener and store that in an array (i.e. pre-dereference the listener functions).  </s>
<s> I'm glad I asked.  </s>
<s> Thanks Curt, Mike Wow a memory-mapped fork bomb!  </s>
<s> Now what on earth did you expect?  </s>
<s> - lkml  </s>
<s> I don't know if the anticipated errata would mandate that behavior or simply tolerate it.  </s>
<s> In my non-public implementation, I followed the specified behavior, but it definitely added complexity.  </s>
<s> Actually, you should already have to collect the listeners since event listeners added while processing a dispatch to the same target should not see the event.  </s>
<s> It was that tension between adding event listeners that  </s>
<s> shouldn't be effective until the current event dispatch is complete and removing event listeners that should be instantaneously effective that made the implementation a little complicated.  </s>
<s> I don't have the code in front of me, but if I remember right, I keep a document wide count of removeEventListener calls.  </s>
<s> During the dispatch to an event, I collect a list of event listeners on that target and start dispatching to the list.  </s>
<s> If the count changes during a dispatch to a particular listener, all other listeners are double checked to see if they are still registered before dispatching the event.  </s>
<s> It would be good to hear the rationale why the behavior in the spec is undesirable and get a survey of current implementations.  </s>
<s> My personal take would be to do whatever is easiest, either following the spec as written or following Xerces-J's implementation, and wait for the errata.  </s>
<s> Also, review the other issues in the message I cited since it also raises issues between my reading of the spec and Xerces-J's implementation, however definitely on passages that are ambiguous.  </s>
<s> The "DOM2" implementation, currently hosted as "gnu.xml.dom.*" at scans each node's listeners and collects the ones interested in each event (so adding listeners to that node during event delivery to it is a NOP) and then delivers events to all of those.  </s>
<s> That is, addition and removal of listeners have comparable behaviors with respect to a node's "listener set" during event delivery: all such adds/removes are ignored until the next node's deliveries start.  </s>
<s> I tend to think that the spec should require that behavior for removal.  </s>
<s> It's more consistent with behavior during addition, so the principle of least surprises applies.  </s>
<s> It also reduces per-node costs for event delivery.  </s>
<s> - Dave p.s.  </s>
<s> This was probably the first implementation of DOM Level 2 that supported events (yep, months before Xerces).  </s>
<s> I'm curious: does anyone recall when that "remove" requirement went in?  </s>
<s> I could believe it's always been there, or that it crept in during some later draft.  </s>
<s> The change appeared to occur between then 7 March 2000 and 20 May 2000 drafts.  </s>
<s> The language is pretty explicit, the current Xerces-J (and gnu whatever) implementation is consistent with the 7 March draft and inconsistent with the 20 May and eventual recommendation.  </s>
<s> This does not appear to be an editorial or clarification issue, but invalidating a purposeful change to the spec.  </s>
<s> From http://www.w3.org/TR/2000/CR-DOM-Level-2-20000307/events.html#Events-EventTarget-removeEventListener (2 March 2000) This method allows the removal of event listeners from the event target.  </s>
<s> If an EventListener is removed from an EventTarget while it is processing an event, it will still be triggered by the current actions but will not be triggered again during any later stages of event flow, such as bubbling.  </s>
<s> Calling removeEventListener with arguments which do not identify any currently registered EventListener on the EventTarget has no effect.  </s>
<s> From http://www.w3.org/TR/2000/CR-DOM-Level-2-20000510/events.html#Events-EventTarget-removeEventListener (20 May 2000 and very close if not identical to the text in the recommendation) This method allows the removal of event listeners from the event target.  </s>
<s> If an EventListener is removed from an EventTarget while it is processing an event, it will not be triggered by the current actions.  </s>
<s> EventListeners can never be invoked after being removed.  </s>
<s> Calling removeEventListener with arguments which do not identify any currently registered EventListener on the EventTarget has no effect.  </s>
<s> And it is so.  </s>
<s> Not too bad actually.  </s>
<s> int DOM_EventTarget_dispatchEvent(DOM_EventTarget *target, DOM_Event *evt) DOM_EventTarget **targets, *t; ListenerEntry *e; unsigned int tcount, i, j, lcount; if (target == NULL || evt == NULL) { DOM_Exception = DOM_NULL_POINTER_ERR; return 1; if (evt- type == NULL || *evt- type == '\0') { DOM_EventException = DOM_UNSPECIFIED_EVENT_TYPE_ERR; return 1; evt- target = target; /* post-initialization */ evt- timeStamp = time(NULL); if (evt- timeStamp == (time_t)-1) { DOM_Exception = DOM_SYSTEM_ERR; return 1; evt- sp = 0; evt- pd = 0; tcount = 0; /* count targets/ancestors */ for (t = target- parentNode; t; t = t- parentNode) { tcount++; if (tcount) { targets = malloc(sizeof *targets * tcount); if (targets == NULL) { DOM_Exception = DOM_NO_MEMORY_ERR; return 1; i = tcount; /* save state of tree in targets array */ for (t = target- parentNode; t; t = t- parentNode) { targets[--i] = t; /* Trigger capturers evt- eventPhase = DOM_EVENT_CAPTURING_PHASE; for (i = 0; i  tcount &amp;&amp; evt- sp == 0; i++) { DOM_EventListener listeners[targets[i]- num_listeners]; /* use stack ok? */ t = targets[i]; lcount = 0; /* copy relevant listener functions */ for (j = 0; j  t- num_listeners; j++) { e = t- listeners[j]; if (e- useCapture &amp;&amp; DOM_String_cmp(e- type, evt- type) == 0) { listeners[lcount++] = e- listener; evt- currentTarget = t; while (lcount) { listeners[--lcount](evt); /* Trigger regular listeners evt- eventPhase = DOM_EVENT_AT_TARGET; if (target- num_listeners &amp;&amp; evt- sp == 0) { DOM_EventListener listeners[target- num_listeners]; lcount = 0; for (j = 0; j  target- num_listeners; j++) { e = target- listeners[j]; if (e- useCapture == 0 &amp;&amp; DOM_String_cmp(e- type, evt- type) == 0) { listeners[lcount++] = e- listener; evt- currentTarget = target; while (lcount) { listeners[--lcount](evt); /* Trigger bubblers evt- eventPhase = DOM_EVENT_BUBBLING_PHASE; i = tcount; while (i-- &amp;&amp; evt- sp == 0) { DOM_EventListener listeners[targets[i]- num_listeners]; t = targets[i]; lcount = 0; for (j = 0; j  t- num_listeners; j++) { e = t- listeners[j]; if (e- useCapture == 0 &amp;&amp; DOM_String_cmp(e- type, evt- type) == 0) { listeners[lcount++] = e- listener; evt- currentTarget = t; while (lcount) { listeners[--lcount](evt); free(targets); return evt- pd; Wow a memory-mapped fork bomb!  </s>
<s> Now what on earth did you expect?  </s>
<s> - lkml  </s>
<s> Makes sense.  </s>
<s> Both the "DOM2" and Xerces implementations had been rarin' to go for a while by then.  </s>
<s> That 10 May (not 20 May :) CR was number three or four in a long series.  </s>
<s> The question then is _why_ this changed.  </s>
<s> It wasn't broken, or else multiple implementations couldn't have been ready... - Dave  </s>
<s> Of course, deliberations of the DOM WG aren't available to the public.  </s>
<s> I did take a look at the Netscape code, though I didn't test it.  </s>
<s> My reading of the code is that it would conform (and was possibly the motivation for the change) since it appears to delete the listener as part of the removeEventListener code.  </s>
<s> I think we should have ample opportunities for errata when we get into the meat of the DOM Test Suite process, which should happen shortly.  </s>
<s> The third test checks removing an event listener in the middle of an event dispatch sequence.  </s>
<s> The spec says that a listener should recieve no events after removal.  </s>
<s> You're right there, that's what the spec currently says.  </s>
<s> But the spec is wrong, though.  </s>
<s> It is meant to say the opposite.  </s>
<s> I just double-checked with Joe Kesselman who was very much involved in the development of that spec and who implemented it in Xerces and he confirmed my fears.  </s>
<s> I will bring it up to the DOM Working Group, I would expect an erratum to be published.  </s>
<s> The DOM Level 2 specification reflects our intent.  </s>
<s> An event listener will never be invoked after it is removed.  </s>
<s> I did the search and found the response ... in the DOM public mailing list.  </s>
<s> We changed the specification following a comment from Ralph Levien during the CR phase:  </s>
<s> Philippe  </s>
<s> That shows that several folk raised the issue of that change introducing an asymmetry with respect to addEventListener(), which should have been dealt with at the same time.  </s>
<s> I think the corresponding change on the addEventListener side is a guarantee that a listener added to the current node _will_ be invoked as appropriate.  </s>
<s> That still leaves the order of event delivery loosely defined, but doesn't create a surprise in the API model.  </s>
<s> (And it'd certainly reduce implementation complexity.) - Dave  </s>
