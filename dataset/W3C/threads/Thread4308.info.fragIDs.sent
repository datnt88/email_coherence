<s> The wording in 7.4.10 fn:escape-uri of the Functions and Operators WD  </s>
<s> seems to suggest that the percent sign '%' is not escaped if $escape-reserved is false.  </s>
<s> (Because '%' is neither a reserved character in RFC2396 nor in RFC2732.) If I'd be picky then the wording "If $escape-reserved is false, the behavior differs in that characters referred to in [RFC 2396] and [RFC 2732] as reserved characters, together with the NUMBER SIGN '#' character, (See [Uniform Resource Identifiers (URI): Generic Syntax]) are not escaped.  </s>
<s> These characters are ..." tells me that *only* these reserved characters will be not escaped.  </s>
<s> The rules would be easier to understand if it could be rephrased along the lines: - Regardless of $escape-reserved the following characters will be escaped: .. - If and only if $escape-reserved is false then additionally the following characters will be escaped: ...  </s>
<s> Last comment: the sentence (at the beginning of this section) "The effect of the function is to replace any special character in the string by an escape sequence of the form %HH, where HH... is the hexadecimal representation of the octets used to represent the character in UTF-8." could be interpreted as to generate one % and then the hex representations of all UTF-8 octets.  </s>
<s> Especially the "HH..." seems to suggest this  </s>
<s> interpretation.  </s>
<s> Perhaps the phrase "an escape sequence of %HH parts" or something like that makes the intention clearer and unambiguous.  </s>
<s> Regards, Oliver Becker  </s>
<s> ob|do Dipl.Inf.  </s>
<s> Oliver Becker | --+-- E-Mail: obecker@informatik.hu-berlin.de  </s>
<s> | op|qo WWW: http://www.informatik.hu-berlin.de/~obecker  </s>
<s> |  </s>
<s> If the example at the end would contain at least one non-ASCII character then the desired behaviour would also be much clearer.  </s>
<s> Oliver Becker  </s>
<s> ob|do Dipl.Inf.  </s>
<s> Oliver Becker | --+-- E-Mail: obecker@informatik.hu-berlin.de  </s>
<s> | op|qo WWW: http://www.informatik.hu-berlin.de/~obecker  </s>
<s> |  </s>
<s> Oliver: This is in reply to your mail below and the accompanying 3 notes on the same subject.  </s>
<s> The F&amp;O taskforce discussed your editorial suggestions on the Dec 9 telcon and agreed to clarify the wording and add an example.  </s>
<s> Here is suggested wording for this function.  </s>
<s> Please take a look.  </s>
<s> 7.4.10 fn:escape-uri fn:escape-uri($uri-part as xs:string?, $escape-reserved as xs:boolean) as xs:string Summary: This function applies the URI escaping rules defined in section 2 of [RFC 2396] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html as amended by [RFC 2732] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html , with one exception, to the string supplied as $uri-part, which typically represents all or part of a URI.  </s>
<s> The effect of the function is to escape a set of identified characters in the string.  </s>
<s> Each such character is replaced in the string by an escape sequence of the form %HH, where HH is the hexadecimal representation of the octets used to represent the character in UTF-8.  </s>
<s> The set of characters that are escaped depends on the setting of the boolean argument $escape-reserved.  </s>
<s> If $uri-part is the empty sequence, returns the zero-length string.  </s>
<s> If $escape-reserved is true, all characters are escaped other than the lower case letters a-z, the upper case letters A-Z, the digits 0-9, the PERCENT SIGN "%" and the NUMBER SIGN "#" characters and the characters referred to in [RFC 2396] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html as "marks": specifically, HYPHEN-MINUS ("-"), LOW LINE ("_"), FULL STOP ".", EXCLAMATION MARK "!", TILDE "~", ASTERISK "*", APOSTROPHE "'", LEFT PARENTHESIS "(", and RIGHT PARENTHESIS ")".  </s>
<s> If $escape-reserved is false, all characters are escaped other than the lower case letters a-z, the upper case letters A-Z, the digits 0-9, the PERCENT SIGN "%" and the NUMBER SIGN "#" characters and the characters referred to in [RFC 2396] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html as "marks": HYPHEN-MINUS ("-"), LOW LINE ("_"), FULL STOP ".", EXCLAMATION MARK "!", TILDE "~", ASTERISK "*", APOSTROPHE "'", LEFT PARENTHESIS "(", and RIGHT PARENTHESIS ")".  </s>
<s> In addition, the characters referred to in [RFC 2396] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html and [RFC 2732] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html as reserved characters, (See [Uniform Resource Identifiers (URI): Generic Syntax] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html ) are not escaped.  </s>
<s> These characters are: SEMICOLON ";", SOLIDUS "/", QUESTION MARK "?", COLON ":", COMMERCIAL AT "@", AMPERSAND "&amp;", EQUALS SIGN "=", PLUS SIGN "+", DOLLAR SIGN "$", COMMA "," NUMBER SIGN "#", LEFT SQUARE BRACKET "[" and RIGHT SQUARE BRACKET "]".  </s>
<s> [RFC 2396] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html does not define whether escaped URIs should use lower case or upper case for hexadecimal digits.  </s>
<s> To ensure that escaped URIs can be compared using string comparison functions, this function must always generate hexadecimal values using the upper-case letters A-F.  </s>
<s> Generally, $escape-reserved should be set to true when escaping a string that is to form a single part of a URI, and to false when escaping an entire URI or URI reference.  </s>
<s> 7.4.10.1 Examples *fn:escape-uri ("http://www.example.com/Weather/CA/Los%20Angeles#ocean",  </s>
<s> true()) returns "http%3A%2F%2Fwww.example.com%2F00%2FWeather%2FCA%2FLos%20Angeles#ocean"  </s>
<s> *fn:escape-uri ("http://www.example.com/00/Weather/CA/Los%20Angeles#ocean",  </s>
<s> false()) returns "http://www.example.com/00/Weather/CA/Los%20Angeles#ocean"  </s>
<s> *fn:escape-uri ("http://www.example.com/~b%e9b%e9",  </s>
<s> true()) returns "http://www.example.com/%7Eb%E9b%E9"  </s>
<s> All the best, Ashok The wording in 7.4.10 fn:escape-uri of the Functions and Operators WD seems to suggest that the percent sign '%' is not escaped if $escape-reserved is false.  </s>
<s> (Because '%' is neither a reserved character in RFC2396 nor in RFC2732.) If I'd be picky then the wording  </s>
<s> "If $escape-reserved is false, the behavior differs in that characters referred to in [RFC 2396] and [RFC 2732] as reserved characters, together with the NUMBER SIGN '#' character, (See [Uniform Resource Identifiers (URI): Generic Syntax]) are not escaped.  </s>
<s> These characters are ..." tells me that *only* these reserved characters will be not escaped.  </s>
<s> The rules would be easier to understand if it could be rephrased along the lines: - Regardless of $escape-reserved the following characters will be escaped: .. - If and only if $escape-reserved is false then additionally the following characters will be escaped: ... Last comment: the sentence (at the beginning of this section) "The effect of the function is to replace any special character in the string by an escape sequence of the form %HH, where HH... is the hexadecimal representation of the octets used to represent the character in UTF-8." could be interpreted as to generate one % and then the hex representations of all UTF-8 octets.  </s>
<s> Especially the "HH..." seems to suggest this interpretation.  </s>
<s> Perhaps the phrase "an escape sequence of %HH parts" or something like that makes the intention clearer and unambiguous.  </s>
<s> Regards, Oliver Becker  </s>
<s> | ob|do Dipl.Inf.  </s>
<s> Oliver Becker | | --+-- E-Mail: obecker@informatik.hu-berlin.de  </s>
<s> | | op|qo WWW: http://www.informatik.hu-berlin.de/~obecker  </s>
<s> |  </s>
<s> fn:escape-uri ("http://www.example.com/~b%e9b%e9",  </s>
<s> true()) returns "http://www.example.com/%7Eb%E9b%E9"  </s>
<s> This one is wrong, unfortunately.  </s>
<s> The correct answer is (I believe) http%3A%2F%2Fwww.example.com%2F~b%C3%A9b%C3%A9  </s>
<s> A better example is fn:escape-uri ("http://www.example.com/~b%e9b%e9",  </s>
<s> false()) which returns Note (a) that the characters are converted to UTF-8 octets, and then hex-encoded, and (b) tilde is in the list of characters that aren't escaped, whatever the setting of the second argument.  </s>
<s> This also means that your sentence: Each such character is replaced in the string by an escape sequence of the form %HH, where HH is the hexadecimal representation of the octets used to represent the character in UTF-8.  </s>
<s> would be better written as: Each such character is replaced in the string by an escape sequence, which is formed by encoding the character as a sequence of octets in UTF-8, and then representing each of these octets in the form %HH, where HH is the hexadecimal representation of the octet.  </s>
<s> Michael Kay  </s>
<s> I wonder if it is really necessary to repeat the whole list of characters that are never escaped (regardless of $escape-reserved).  </s>
<s> As a reader I would assume a subtle difference between these paragraphs, but there isn't.  </s>
<s> (aside from the "specifically" ;-) Wouldn't it be more readable to specify this list only once?  </s>
<s> Almost.  </s>
<s> The argument URI should read "http://www.example.com/00/Weather/CA/Los%20Angeles#ocean"  </s>
<s> (like in the second example, note the missing "/00") The third example has been already commented by Michael Kay. Best regards, Oliver Becker  </s>
<s> - add a comma after COMMA "," - The number sign "#" appears twice (it is already mentioned in the first paragraph) Regards, Oliver Becker  </s>
<s> Oliver:  </s>
<s> Thanks for your close reading if the spec.  </s>
<s> Here is another crack at proposed wording.  </s>
<s> 7.4.10 fn:escape-uri  </s>
<s> fn:escape-uri($uri-part as xs:string?, $escape-reserved as xs:boolean) as xs:string Summary: This function applies the URI escaping rules defined in section 2 of [RFC 2396] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html as amended by [RFC 2732] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html , with one exception, to the string supplied as $uri-part, which typically represents all or part of a URI.  </s>
<s> The effect of the function is to escape a set of identified characters in the string.  </s>
<s> Each such character is replaced in the string by an escape sequence, which is formed by encoding the character as a sequence of octets in UTF-8, and then representing each of these octets in the form %HH, where HH is the hexadecimal representation of the octet.  </s>
<s> The set of characters that are escaped depends on the setting of the boolean argument $escape-reserved.  </s>
<s> If $uri-part is the empty sequence, returns the zero-length string.  </s>
<s> If $escape-reserved is true, all characters are escaped other than the lower case letters a-z, the upper case letters A-Z, the digits 0-9, the PERCENT SIGN "%" and the NUMBER SIGN "#" characters and the characters referred to in [RFC 2396] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html as "marks": specifically, HYPHEN-MINUS ("-"), LOW LINE ("_"), FULL STOP ".", EXCLAMATION MARK "!", TILDE "~", ASTERISK "*", APOSTROPHE "'", LEFT PARENTHESIS "(", and RIGHT PARENTHESIS ")".  </s>
<s> If $escape-reserved is false, additional characters are added to the list of characters that are not escaped.  </s>
<s> These are the characters referred to in [RFC 2396] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html and [RFC 2732] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html as reserved characters, (See [Uniform Resource Identifiers (URI): Generic Syntax] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html ) and consist of the following: SEMICOLON ";", SOLIDUS "/", QUESTION MARK "?", COLON ":", COMMERCIAL AT "@", AMPERSAND "&amp;", EQUALS SIGN "=", PLUS SIGN "+", DOLLAR SIGN "$", COMMA ",", NUMBER SIGN "#", LEFT SQUARE BRACKET "[" and RIGHT SQUARE BRACKET "]".  </s>
<s> [RFC 2396] file:///C:\XMLSpecs\Query\FandO\Work\xpath-functions.html does not define whether escaped URIs should use lower case or upper case for hexadecimal digits.  </s>
<s> To ensure that escaped URIs can be compared using string comparison functions, this function must always generate hexadecimal values using the upper-case letters A-F.  </s>
<s> Generally, $escape-reserved should be set to true when escaping a string that is to form a single part of a URI, and to false when escaping an entire URI or URI reference.  </s>
<s> 7.4.10.1 Examples *fn:escape-uri ("http://www.example.com/00/Weather/CA/Los%20Angeles#ocean",  </s>
<s> true()) returns "http%3A%2F%2Fwww.example.com%2F00%2FWeather%2FCA%2FLos%20Angeles#ocean"  </s>
<s> *fn:escape-uri ("http://www.example.com/00/Weather/CA/Los%20Angeles#ocean",  </s>
<s> false()) returns "http://www.example.com/00/Weather/CA/Los%20Angeles#ocean"  </s>
<s> *fn:escape-uri ("http://www.example.com/~b%e9b%e9",  </s>
<s> false()) returns "http://www.example.com/~b%C3%A9b%C3%A9"  </s>
<s> All the best, Ashok  </s>
<s> - add a comma after COMMA "," - The number sign "#" appears twice (it is already mentioned in the first paragraph) Regards, Oliver Becker  </s>
<s> | ob|do Dipl.Inf.  </s>
<s> Oliver Becker | | --+-- E-Mail: obecker@informatik.hu-berlin.de  </s>
<s> | | op|qo WWW: http://www.informatik.hu-berlin.de/~obecker  </s>
<s> |  </s>
<s> Ashok,  </s>
<s> Apart from the fact that it is IMHO not necessary to specify NUMBER SIGN "#" twice, I'm happy with that.  </s>
<s> :-) Regards, Oliver  </s>
