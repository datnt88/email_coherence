<s> In looking through the DOM specs, I could not discern a way to do the  </s>
<s> following:  </s>
<s> Given two nodes of a common parent, identify which node precedes the other  </s>
<s> in the parent's ChildNodes nodelist.  </s>
<s> Is there such a creature in the current specs?  </s>
<s> Regards, -Tom  </s>
<s> You'd basically look at the nodelist yourself.  </s>
<s> Takes a few lines  </s>
<s> of code -- would you seriously expect DOM to save you the work of writing such a simple subroutine?  </s>
<s> If so, why?  </s>
<s> - Dave  </s>
<s> On Monday, February 28, 2000 5:50 PM, David Brownell [mailto:david-b@pacbell.net]  </s>
<s> Dave, DOM allows me to access a childNode directly by using the item(index) method off of the nodelist that is returned from childNodes, rather than walking the nodelist.  </s>
<s> So, I was expecting that if I had the reference to the childNode, it would  </s>
<s> have an index property that I would be able to use for routines like this,  </s>
<s> rather than having to examine the nodelist itself.  </s>
<s> Am I really expecting too much?  </s>
<s> :-)  </s>
<s> -Tom  </s>
<s> other  </s>
<s> I've heard one strong case where an ordering query would be useful -- not on NodeLists, but on lists of nodes generated in other ways.  </s>
<s> That case is XSLT.  </s>
<s> It's not uncommon there to want to take the union of several seperately executed searches and present it as a single list of nodes, in document order.  </s>
<s> In that situation, convolving the lists to interleave them correctly can be a significantly expensive operation.  </s>
<s> We've had periodic requests from XSLT developers to add a Node.isBefore(Node) operation, which they could invoke in the hope that a specific DOM might have an underlying representation which permits optimizing this operation.  </s>
<s> Given that some models _can_ answer this question much more quickly via their internal representations than via their DOM API, I think it's worth considering.  </s>
<s> Statement of bias: I wrote one such model; that fast-ordering feature is one of several reasons LotusXSL/Xalan prefers to read the input document from DTM rather than from a "normal" DOM.  </s>
<s> Joe Kesselman / IBM Research  </s>
<s> Right, the "list" can be implemented as an array (easy to implement the "item" method) or as a linnked list (more awkward) or some other data structure.  </s>
<s> Perhaps.  </s>
<s> If you got used to using it, the linked list implementation would accumulate some bizarre costs since it'd need to recompute that property pretty often ... but that'd be more reasonable than asking for a specific "is this child before that one" primitive, as you'd seemed to be suggesting!  </s>
<s> - Dave  </s>
<s> would  </s>
<s> this,  </s>
<s> You're expecting a particular implementation.  </s>
<s> In some implementations, a node does indeed have an index property within its parent.  </s>
<s> But others only know who their parent and immediate siblings are; to get their index, they would have to walk the sibling chain, "counting on their fingers".  </s>
<s> It might be more efficient to instead walk until you either find the other sibling or fail to find it, and just return that relative positioning rather than absolute.  </s>
<s> Note that the general case of relative positioning of two nodes is harder; you have to determine the lowest common ancestor, then determine which one comes earlier.  </s>
<s> And you have to deal with the case where there _isn't_ a common ancestor... and decide whether to report attributes that way, or as falling between their owning Element and its children... while remember that either way, the attributes are officially unordered relative to each other.  </s>
<s> Remember, NodeLists are not necessarily implemented as arrays of nodes.  </s>
<s> They're live filtered views of the document which just happen to be integer-indexed to make them easier to use for folks who think in terms of arrays.  </s>
<s> But they're arguably more closely related to the DOM Level 2 NodeIterator and TreeWalker than to a simple array.  </s>
<s> Joe Kesselman / IBM Research  </s>
<s> Furthermore, if the element is part of an entity, then no single index will work, as the element node may be in the tree in multiple places.  </s>
<s> Schlingt dreifach einen Kreis vom dies!  </s>
<s> || John Cowan jcowan@reutershealth.com Schliesst euer Aug vor heiliger Schau, || http://www.reutershealth.com  </s>
<s> Denn er genoss vom Honig-Tau, || http://www.ccil.org/~cowan  </s>
<s> Und trank die Milch vom Paradies.  </s>
<s> -- Coleridge (tr.  </s>
<s> Politzer)  </s>
<s> Actually I tend to disagree on that one.  </s>
<s> There is some nasty text in the DOM spec saying that the "same" nodes are EntityRef children as are children of the respective Entity.  </s>
<s> Is  </s>
<s> that what you're thinking about?  </s>
<s> But that notion of "same" seems to me like it must be (equals?  </s>
<s> a b) rather than (eq?  </s>
<s> a b), to sneak in two LISP primitives ... since, unlike the case with LISP, DOM nodes have (non-null) ancestors that prevent them from being in more than one place at a time.  </s>
<s> A DOM is a tree,  </s>
<s> not a general graph.  </s>
<s> (Note to DOM WG: Perhaps the prose on that part of the DOM spec needs to say what it means by "same"?) - Dave  </s>
<s> This gets into questions of whether multiple copies of an entity share the same nodes or not... and how the user can tell.  </s>
<s> I'm not sure that the DOM makes any promises either way.  </s>
<s> Some of the open questions about how parsed entities and namespaces interact make that sharing less likely than it once was.  </s>
<s> Reminder, since we're on the topic: node identity does not require object  </s>
<s> identity.  </s>
<s> In some DOM bindings, asking whether it's the same object is not  </s>
<s> the right test.  </s>
<s> One of the outstanding issues is the possibility of adding a Node.isSameNode(Node) test, which would work in all bindings.  </s>
<s> Joe Kesselman / IBM Research  </s>
<s> "identity" being as fuzzy a notion as "equality" -- I said this earlier  </s>
<s> in terms of (eq?  </s>
<s> a b) and (equals?  </s>
<s> a b).  </s>
<s> Would such a test ever be meaningful except for two readonly nodes inside of an entity (reference)?  </s>
<s> If not, is there really a compelling use case for such a primitive?  </s>
<s> - Dave  </s>
<s> Umph. Yes, it does, doesn't it.. Core, section 1.1.8:  </s>
<s> "In a document with no namespaces, the child list of an EntityReference node is always the same as that of the corresponding Entity."  </s>
<s> And again in the description of createEntityReference.  </s>
<s> We should probably rephrase that as "equivalent to", or something of that sort.  </s>
<s> Possibly with explanation.  </s>
<s> Good catch!  </s>
<s> Very good point.  </s>
<s> A DOM implementation may or may not be able to share data behind the scenes, but the children of one EntityReference are _not_ "the same nodes" as children of another reference to the same entity; a node can only have one parent.  </s>
<s> There are also some issues about how Namespace prefixes are to be handled in entities.  </s>
<s> 1.1.8 discusses those concerns.  </s>
<s> Joe Kesselman / IBM Research  </s>
<s> object  </s>
<s> As long as we remember that there are two distinct kinds of "identity" being discussed, it's not so bad: Node identity is clearly defined in terms of the DOM, and is a necessary concept for a significant number of common tree processing operations.  </s>
<s> As one example, take the case of unioning several searches into a single list of nodes; if you can't ask "is this a node I've seen before", you can't discard duplicates.  </s>
<s> Or, consider a hand-coded subtree walker; if you can't ask "is this the root node I started from", you can't stop yourself from walking out of that subtree.  </s>
<s> Most of us have been blythely assuming that object identity -- the programming language's node1==node2 or equivalent -- can be used to test for node identity.  </s>
<s> But in DOMs which operate as a proxy for other data representations, it is possible that several DOM Node objects may in fact be handles for the same node.  </s>
<s> In that case, == will return false (unless you're in a language that permits overriding =='s behavior), but Node.isSameNode(Node) would be defined as returning true.  </s>
<s> Equality is yet another question, of course.  </s>
<s> Presumably equality would be defined as "represents the same content".  </s>
<s> We've dithered a bit about exactly how to define that -- specifically, about whether there's one definition that really works for the majority of cases -- and between that and the lack of a compelling need (since this test _can_ be implemented in terms of the public DOM API), it's been deferred.  </s>
<s> The main argument for moving it into the DOM would be that some DOMs might want to apply hashing or other techniques to improve performance.  </s>
<s> Joe Kesselman / IBM Research  </s>
<s> I'm not sure where this discussion left off.  </s>
<s> My take on this, which others may disagree with: 1) The request for isBefore/isAfter has been made before, by XSLT implementors.  </s>
<s> Adding it might be a Good Thing, since in DOMs which do optimize it the benefits could be very large.  </s>
<s> 2) getIndexOf strikes me as The Wrong Thing.  </s>
<s> Not powerful enough to be really useful, and has the same problems as any other integer-indexed access to the DOM -- that being that when the document is edited, stored indices become incorrect and you're stuck with recalculation overhead.  </s>
<s> Though I admit to being strongly biased against NodeLists to begin with.  </s>
<s> Neither is currently on the Open Issues list for DOM Level 3. I suppose I should add them.  </s>
<s> Joe Kesselman / IBM Research  </s>
<s> No. I, too, would find one useful.  </s>
<s> And different implementations might optimize it differently if it were a standard method in DOM.  </s>
<s> Once nodes with a common parent are found, trace previous / next in a loop (I do both simultaneously) and see which direction one can be found from the other.  </s>
<s> If the nodes are not known to be siblings, the procedure is only a bit more complicated.  </s>
<s> Unfortunately, this requires you to be able to detect whether two node objects within a hierarchy represent the same node.  </s>
<s> In some implementations, this can be done by using an == comparison on the object references, but there is no guarantee that the same object will always be returned for a specific node,  </s>
<s> so this order comparison cannot be performed portably, unless I missed something.  </s>
<s> The inability to compare node identity is an omission that needs to be resolved.  </s>
<s> Alternatively, it might be possible to use Level 2 optional ranges to answer the question, by setting start and end, and checking whether the range has collapsed using the isCollapsed attribute.  </s>
<s> To me, this seems to be an appropriate use of ranges, if your DOM implementation is level 2 and supports ranges.  </s>
<s> Is anyone aware of a better approach?  </s>
<s> Ray Whitmer ray@xmission.com  </s>
<s> Does anyone have a specific use case for getIndexOf, for inclusion in the open-issue description?  </s>
<s> Or is it just being requested on the basis of symmetry with NodeList.item()?  </s>
<s> Joe Kesselman / IBM Research  </s>
<s> In XML the order of nodes is defined to be significant.  </s>
<s> Even if you construct cases where it is not "conceptually", such as an RDB export into XML syntax, the order is still significant by definition; just as the order or records in a relation is by definition *not* significant, even if there is some serial-number or other field floating around that implies an order to apps/people that know.  </s>
<s> Given that XML is ordered, it does seem pretty strange to not be able to determine what order any given two things are in.  </s>
<s> Put another way, the lack of such functionality contradicts the data model.  </s>
<s> I would say that is *why* operations are being asked for that turn out to be very expensive to simulate.  </s>
<s> Just like when you simulate XML with an RDB: traversing nodes just to do an identity export of a document in the right order, requires extra fields or relations plus a whole lot of sorting -- one big sort if your RDB models XML via generic nodes, a gazillion little sub-selects and sorts if it instead uses a separate relation for each element type.  </s>
<s> It isn't surprising in either case that you can simulate the other data model -- but it costs.  </s>
<s> The data model and data architecture mismatch, and that generally leads to high costs down the line.  </s>
<s> Much better to add the facility and make the interface match the data model better.  </s>
<s> Calculate O() for the common operations needed to keep all the intermediate results in XPath (and therefore also XPointer) in order, it will add up real fast.  </s>
<s> Steven_DeRose@Brown.edu; http://www.stg.brown.edu/~sjd  </s>
<s> Chief Scientist, Scholarly Technology Group, and Adjunct Associate Professor, Brown University North American Editor, the Text Encoding Initiative  </s>
<s> The uncertainty is inherent in large scale systems; "identity" is a rather complex topic once you start to explore it.  </s>
<s> The short version of a _really_ long story is that object identity in a proxied/distributed system is a very hard notion.  </s>
<s> Within any small problem domain you can often make it testable.  </s>
<s> I've observed that people working exclusively inside one database tend to assume it's always testable (e.g. by tuple ID) while people integrating over wider data domains tend to assume the opposite.  </s>
<s> The convenient line is generally: within one address space, it may be practical to impose a policy that identity is testable, usually with a primitive like "==".  </s>
<s> As that single address space gets larger, that can become impractical ... and between address spaces it's often impractical to get trustworthy _and_ efficient answers.  </s>
<s> (Unless you turn it into a problem isomorphic with a single address space: master server and lots of clients or slave servers, for example.)  </s>
<s> You don't need a strong notion of object identity in order to answer the ordering question.  </s>
<s> Ordering is a specific problem domain notion that is only incidentally related to the general problem of identity.  </s>
<s> - Dave  </s>
<s> And I spoke too quickly.  </s>
<s> In the particular case given, where the nodes are known to be children of the same parent, you can just use getNextSibling to count the number of next siblings of each node, and the node with more next siblings comes first.  </s>
<s> Ray Whitmer ray@imall.com  </s>
<s> Being ordered, and being able to easily extract ordering information, are two different things.  </s>
<s> All the information required does already exist in the DOM API, though not in a convenient form: Make sure the two nodes aren't the same node (if they are, neither preceeds the other) Find lowest common ancestor of the two nodes Walk its immediate children left to right Stop when you find the first child whose subtree contains one of the two nodes.  </s>
<s> That node comes before the other.  </s>
<s> Implementation is left as an exercise for the reader.  </s>
<s> We don't currently define a single-step query which _only_ returns the who-comes-first information.  </s>
<s> (Nor does the Infoset, as far as I know.) As has been noted there may be reason to add this, both for convenience and because some DOMs may be able to offer a faster implementation based on internal knowledge.  </s>
<s> But it doesn't necessarily have to be added in Level 2, since the do-it-yourself calculation does work.  </s>
<s> Certainly worth further consideration.  </s>
<s> It's been placed on the open issues list.  </s>
<s> Joe Kesselman / IBM Research  </s>
<s> I'm not sure where this discussion left off.  </s>
<s> The original question was something like: is there a method that will allow the user to check the document order of two nodes.  </s>
<s> This seems like a reasonable request to me, and one that many of us have had to implement ourselves while using (and implementing) the DOM.  </s>
<s> I'm sure this was discussed in the past, but dismissed for implementation reasons.  </s>
<s> So at the risk of kicking a dead horse, I'd suggest that two sets of methods would be useful.  </s>
<s> The first being index-based: // return index of child or -1 if not an immediate child int Node.getIndexOf(Node child); // return this node's index in its parent's child list, or -1 if not a child.  </s>
<s> int Node.getIndex()  </s>
<s> The second set of operations is relational: // return true if arg is positioned before this node.  </s>
<s> // If deep is false, only siblings are checked.  </s>
<s> Otherwise, // the entire document is checked.  </s>
<s> boolean Node.isBefore(Node arg, boolean deep); // return true if arg is positioned after... boolean Node.isAfter(Node arg, boolean deep) For implementations based on an array, the first set will be fast.  </s>
<s> For implementations based on a list, the first could be slow.  </s>
<s> So to make things fair for all implementors, the second set of methods will probably be complicated regardless of implementation.  </s>
<s> Granted, it may require some work on clarifying what happens when 'arg' is a child of an entity, but I would think that implementors would be much more qualified to implement these functions than users.  </s>
<s> It might even help to clarify that portion of the spec.  </s>
<s> David Brownell wrote,  </s>
<s> How about: because some implementations might be able to provide an O(1) implementation, whereas an external routine would be likely to be O(number of siblings) or thereabouts.  </s>
<s> There're several other queries like this which could usefully be added and which might allow for similar optimizations: precedes in document order; is an ancestor of; least common ancestor; depth from root etc.  </s>
<s> Cheers, Miles Miles Sabin Cromwell Media Internet Systems Architect 5/6 Glenthorne Mews msabin@cromwellmedia.com http://www.cromwellmedia.com/  </s>
<s> Just a coding tip: If an optimized operation isn't supported directly in the DOM, consider writing a library routine to encapsulte it.  </s>
<s> This could use custom calls against DOM implementations that provide shortcuts, but fall back on standard DOM operations for those which don't have such features.  </s>
<s> Definitely not as nice as a standard solution, since the wrapper routines  </s>
<s> would have to be aware of specific implementations.  </s>
<s> That makes it a maintainance pain; you have to enumerate those implementations and maintain their special-cases individually.  </s>
<s> And there is a bit of overhead.  </s>
<s> But this sort of approach isn't uncommon right now, as folks try to take advantage of custom features without losing portability (or benefit from Level 2 features without losing the ability to manipulate Level 1 DOMs)... and it has the advantage that if a standardized solution does become available, the wrapper can be trivially switched over to use it without impacting the rest of your code.  </s>
<s> Joe Kesselman / IBM Research  </s>
<s> Joe Kesselman wrote,  </s>
<s> We've done that where appropriate but it's a Disgusting Hack(tm).  </s>
<s> In fact, a lot of the overhead can be eliminated by testing just once against the DOMImplementation and getting back an object which supports a variety of optimized operations over any instance of that impl ... Cheers, Miles Miles Sabin Cromwell Media Internet Systems Architect 5/6 Glenthorne Mews msabin@cromwellmedia.com http://www.cromwellmedia.com/  </s>
<s> Good point.  </s>
<s> A patent search will show you a few O(1) methods for SGML, and there are other ways known since, some published in the last few years of the ACM Hypertext and Digital Libraries conferences.  </s>
<s> The performance difference could easily be even worse.  </s>
<s> Some implementations such as many based on B-trees, are worse than O(number of siblings) because the time to examine each sibling is worse than O(k) and the costs multiply.  </s>
<s> Implementations *ought* to do no worse than you describe, but even O(|siblings|) vs. O(1) is a *big* deal sometimes; I've seen lots of real user documents with sibling-lists in the 10,000 range.  </s>
<s> XML data that's exported from RDBs (like a lot of e-commerce interchange, for example) will often have huge fanout.  </s>
<s> a 10,000 to 1 hit on performance seems like a pretty good reason to consider adding an interface for something that so clearly fits the data model anyway....  </s>
<s> Yup; there's a must-read paper in Digital Libraries 98 (+/- 1? sorry, don't have the reference handy, authors were from Korea, though) on ways to optimize the heck out of all these commonplace operations.  </s>
<s> Also some good work in VLDB '99 (though the most relevant ones from there don't actually mention XML in the titles).  </s>
<s> Steve Steven_DeRose@Brown.edu; http://www.stg.brown.edu/~sjd  </s>
<s> Chief Scientist, Scholarly Technology Group, and Adjunct Associate Professor, Brown University North American Editor, the Text Encoding Initiative  </s>
<s> I think it's a natural complement to NodeList.item(), but I've seen a number of instances where index-based access is necessary, usually in cases where the DOM model is adapted to fit existing frameworks.  </s>
<s> Here's one that comes to mind immediately: When displaying a node hierarchy in a graphical interface, it is often necessary to provide access to nodes based on their index relative to their parent--for example, when removing a node using an ActiveX tree control, I need to pass the parent node and the index of the node to delete.  </s>
<s> Of course this is easy to implement yourself, but it would be nice to have it done by the DOM implementation.  </s>
<s> And if the implementation can optimize index-based access, that's another plus.  </s>
<s> The original comment was more along the lines of "can't do this, why?  </s>
<s> aaagh!" as I recall ... not the "it's too slow" that you seem to be suggesting it was.  </s>
<s> It's common that some special purpose task can be sped up by putting it into infrastructure.  </s>
<s> But that in itself is rarely a compelling motivation for making it a "standard, everyone must implement this" part of an infrastructure.  </s>
<s> If everyone has to pay for it, everyone _ought_ to benefit more or less equally from it.  </s>
<s> - Dave  </s>
<s> Got any suggestions about how to weigh the requirements for those (big/huge documents) apps against the other ones?  </s>
<s> Seems to me that if there's a real need for such methods it'd be appropriate to collect them into a new interface, which could optionally be implemented by DOM vendors who are courting applications working with that type of data.  </s>
<s> I'm not yet convinced that those operations are common enough to warrant more than another optional functionality module in DOM.  </s>
<s> Even though you called them "commonplace"; perhaps in your problem domain they are.  </s>
<s> - Dave  </s>
<s> Or -- if the implementation supported the optional "we've got these graph-structure primitives" feature, it could use them without needing custom calls.  </s>
<s> L2 _is_ going to be very clear about how folk other than W3C can define new feature identifiers to pass to Node.hasFeature() isn't it?  </s>
<s> - Dave  </s>
<s> There's language in L2's description of hasFeature that addresses this.  </s>
<s> We might want to tweak that wording slightly.  </s>
<s> It currently says "The legal values are defined throughout this specification and listed in the Compliance section."  </s>
<s> I suspect that we meant to say "The values used by the DOM Specification".  </s>
<s> We should also probably be more explicit about the fact that names without periods (ie, without prefixes) are reserved for use by the DOM spec.  </s>
<s> Joe Kesselman / IBM Research  </s>
