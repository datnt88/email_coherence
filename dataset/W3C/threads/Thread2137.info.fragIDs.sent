<s> I've been getting lots of bug reports due to corrupted or out dated caches.  </s>
<s> I would like to propose an extension to the If-modified-since header to improve the situation.  </s>
<s> I'd like to start sending If-modified-since: DATE; size=SIZE The addition of size=SIZE informs the server of the current size of the document cached by the client.  </s>
<s> The size acts as a checksum, if the size of the file to be served is different than the size given in the If-modified-since header than a 304 should not be returned.  </s>
<s> The advantage of size over other checksums is that it is highly efficient.  </s>
<s> Clients and servers can obtain the information at little or no cost.  </s>
<s> The disadvantage of size is that it is not completely accurate as a checksum.  </s>
<s> An MD5 hash or some other content based checksum would be far more accurate but would require lots of additional overhead.  </s>
<s> In the future, if a stronger checksum is deemed necessary it can be added as another part of the If-modified-since header.  </s>
<s> Perhaps: If-modified-since: DATE; size=SIZE; md5=SIGNATURE I have tested this change against the Netscape, NCSA, CERN and Apache servers and all of them ignore the addition of size=SIZE, so we can add this addition without fear of backwards compatibility concerns.  </s>
<s> Comments?  </s>
<s> :lou Lou Montulli http://www.mcom.com/people/montulli/  </s>
<s> Netscape Communications Corp.  </s>
<s> In article v02120d04ac580956f14c@[198.64.246.22] cshotton@biap.com (Chuck  </s>
<s> This is where you are completely wrong.  </s>
<s> In every case of cache corruption that I have seen it has always been caused by server errors.  </s>
<s> Dates are simply not a strong enough versioning system to prevent lossage.  </s>
<s> As if file size is any better?  </s>
<s> You avoided answering the question, which was why should the server be responsible for essentially maintaining the client/proxy cache?  </s>
<s> This isn't forcing the server to do anything.  </s>
<s> Adding a size simply helps the server to make the correct decision about sending a 304 or not.  </s>
<s> Currently servers are making wrong decisions because it cant tell if the file has changed becaused dates are not strong enough by themselves to do an adequate job of versioning.  </s>
<s> Let's try this one last time.  </s>
<s> Lou, do you agree or disagree that for any two CPUs, they may have different size representation for the same data stream due to EOL differences and or differences between the transmitted content-length and the number of bytes stored on the disk?  </s>
<s> If this is the case (and it IS in many implementations), then using size will NEVER work.  </s>
<s> The client will cache the file with one size, the server will compare it to another "size" and the cached file will always appear to be modified or different.  </s>
<s> The only way to solve this problem is to normalize the "size" to be the content-length instead of the number of bytes stored on disk on either end of the connection.  </s>
<s> This means that the server will have to read and translate the file to recompute the content-length size whenever it is requested.  </s>
<s> Since this is a CPU and disk I/O intensive process, it places a burden on the server that we should try to avoid.  </s>
<s> You seem to be ignoring this flaw in the IMS "size" discussion and it is a fatal flaw.  </s>
<s> This should be done by the client software, through whatever means the client has at its disposal.  </s>
<s> I don't care what the mechanism is.  </s>
<s> I just don't want to see thousands of caching clients beating on servers because they are too lame to keep track of their own cache.  </s>
<s> If a cached file is suspicious because of a date, a file size, or a bad checksum, the client should discard it.  </s>
<s> Period.  </s>
<s> Forcing the server to jump through hoops on every IMS request is contrary to the entire goal of "server serve, clients do the work."  </s>
<s> You seem to be forgetting that "jumping through hoops", as you put it, is going to save the server time in the long run.  </s>
<s> Remember, bandwidth is not free.  </s>
<s> And neither is CPU time or disk I/O.  </s>
<s> These are much more limited on a server handling lots of parallel requests than the net bandwidth on many systems.  </s>
<s> Chuck Shotton StarNine Technologies, Inc. chuck@starnine.com  </s>
<s> http://www.starnine.com/  </s>
<s> cshotton@biap.com http://www.biap.com/  </s>
<s> "Shut up and eat your vegetables!"  </s>
<s> In article v02120d09ac5838de1e3c@[198.64.246.22] cshotton@biap.com (Chuck  </s>
<s> It is not at all a fatal flaw.  </s>
<s> The size returned by the client needs to be specified to be the same as the "content-length" returned by the server during the request.  </s>
<s> If line-feed conversion is being done consistantly the size can be compared accurately.  </s>
<s> This should be done by the client software, through whatever means the client has at its disposal.  </s>
<s> I don't care what the mechanism is.  </s>
<s> I just don't want to see thousands of caching clients beating on servers because they are too lame to keep track of their own cache.  </s>
<s> If a cached file is suspicious because of a date, a file size, or a bad checksum, the client should discard it.  </s>
<s> Period.  </s>
<s> Forcing the server to jump through hoops on every IMS request is contrary to the entire goal of "server serve, clients do the work."  </s>
<s> You seem to be forgetting that "jumping through hoops", as you put it, is going to save the server time in the long run.  </s>
<s> Remember, bandwidth is not free.  </s>
<s> The number of parallel requests are reduced by disconnecting user agents quickly.  </s>
<s> This can be occomplished best via 304.  </s>
<s> If 304 cannot be relied upon to be accurate then it can't be used and data retransmission will have occur during every request.  </s>
<s> That is far more costly than computing a checksum.  </s>
<s> And as I said before, if you are not as concerned about reliability, ignore the size... :lou Lou Montulli http://www.mcom.com/people/montulli/  </s>
<s> Netscape Communications Corp.  </s>
<s> This makes the "content-length" an arbitrary value that must be stored  </s>
<s> out of band in the cache, and returned to the server as part of a  </s>
<s> "version check" request.  </s>
<s> Changing the date comparision from equal to greater than or equal makes the date comparison into another such item, module conversion between date formats (though most file systems have a place reserved for that).  </s>
<s> You could implement this by saving the last-modified header and sending it back as the value of the if-modified-since header.  </s>
<s> If we're going to change the spec for this, and are requiring that clients keep out of band data to comply, why not provide versioning of the kind the server (which has to do the work) wants to support?  </s>
<s> Observation: the version string has no meaning as far as the client is concerned.  </s>
<s> Proposal:  </s>
<s> A new header from servers: Version: Version-string A new header from clients: If-Not-Version: Version-string  </s>
<s> Version-string is a string of characters other than ";" and whitespace.  </s>
<s> Since version-string only has meaning to the server, it can be whatever you want.  </s>
<s> The file size; a VMS file version number; an MD5 digest; a CRC, etc.  </s>
<s> mike  </s>
<s> In article 19950816.75DE920.13DA5@contessa.phone.net  </s>
<s> mwm@contessa.phone.net  </s>
<s> the IMS last modified date is already a value that must be stored out of band in the cache.  </s>
<s> The client local time can not be  </s>
<s> relied upon so it can not be used to compute a last modified date.  </s>
<s> Only in cases where you can guarentee reliable dates (i.e not PC's and not Macs) can you use the local date as a value, I suspect some UNIX proxies do this.  </s>
<s> This would work pretty well but has the disadvantage of not being reproducable on the client end.  </s>
<s> A standardized checksum method  </s>
<s> would remove the need for out of band data to be stored, or if the out of band data was lost, it could be regenerated.  </s>
<s> :lou Lou Montulli http://www.mcom.com/people/montulli/  </s>
<s> Netscape Communications Corp.  </s>
<s> In article 19950817.77E12D0.23E6@contessa.phone.net  </s>
<s> mwm@contessa.phone.net  </s>
<s> The if-different header would occomplish this, but still think it's wasteful.  </s>
<s> We should try and use the existing IMS header if possible.  </s>
<s> If it turns out not to be possible then we should add to the future specification that all http headers can be followed by one or more arguments delimited by semi-colons.  </s>
<s> This will keep this lossage from happening in the future.  </s>
<s> Other than that I'm happy with this proposal.  </s>
<s> Let's keep the names short and get this into some form of a spec so that we can get on with life.  </s>
<s> (not that it hasn't been fun arguing) :lou Lou Montulli http://www.mcom.com/people/montulli/  </s>
<s> Netscape Communications Corp.  </s>
<s> I think I pointed that out; it's important to note, though.  </s>
<s> The IMS LM date has the same problem - the client can't reproduce it.  </s>
<s> I like the more generic "If-different" header.  </s>
<s> We can even tweak it to save 15 of the 20 bytes you complained about: If-Different: 1#( field-name value ; ) The server then verifies that for each field-name/value pair, it is going to send a header with that name whose value (after trimming leading and trailing whitespace) is the same as the client sent on the if-different field.  </s>
<s> If one of them is different it sends the document.  </s>
<s> Otherwise, it sends a 3xx reply "Not different".  </s>
<s> You can therefore get the behavior you want from if-modified-since: last-modified ; size=length with if-different: last-modified ; content-length length and leave if-modified-since with the current definition for those who have a use for that.  </s>
<s> Optional bandwidth reducer: allow the server to not send any headers that are named on the if-different header that haven't changed.  </s>
<s> mike  </s>
