<s> Hi,  </s>
<s> "What should UNLOCK return if a bad token is provided or no token.  </s>
<s> (This might be contingent on UNLOCK_NEEDS_IF_HEADER.)" I just tested this, here are the results (test script attached):  </s>
<s> (a) Microsoft IIS 5.0: (a1) no lock token: 400, (a2) bad lock token: 412.  </s>
<s> (b) Apache/Moddav 2.0.49: (b1) no lock token: 400, (b2): bad lock token: 412.  </s>
<s> (c) SAP Enterprise Portal 5SP6: (c1) no lock token: 412, (c2): bad lock token: 412.  </s>
<s> (d) Xythos (Sharemation): see (c).  </s>
<s> (I also note that Xythos is returning invalid lock tokens) Summarizing: - we can't guarantee a specific status code, - we should define a specific precondition (see proposal at http://greenbytes.de/tech/webdav/draft-reschke-webdav-locking-latest.html#rfc.section.5 ) - we should talk about what is the right thing to do here -- basically  </s>
<s> we need to answer whether "lock-token" is a request header that contributes to precondition checking as defined by RFC2616 ( http://greenbytes.de/tech/webdav/rfc2616.html#status.412 ) -- if we can agree on this, Apache/moddav's behaviour would be correct.  </s>
<s> Feedback appreciated, Julian  </s>
<s> I would vote for treating the lock-token as a request header that contributes to precondition checking, so I agree with the ModDav/Microsoft behavior.  </s>
<s> Cheers, Geoff Julian wrote on 06/06/2004 03:28:21 PM:  </s>
<s> 412.  </s>
<s> '%"$%$?!  </s>
<s> I mistyped the results.  </s>
<s> The actual results are:  </s>
<s> (a) Microsoft IIS 5.0: (a1) no lock token: 400, (a2) bad lock token: 412.  </s>
<s> (b) Apache/Moddav 2.0.49: (b1) no lock token: 400, (b2): bad lock token: 410.  </s>
<s> (c) SAP Enterprise Portal 5SP6: (c1) no lock token: 412, (c2): bad lock token: 412.  </s>
<s> (d) Xythos (Sharemation): see (c).  </s>
<s> (I also note that Xythos is returning invalid lock tokens) RFC2616 treats exactly all "If-*" headers as defining preconditions.  </s>
<s> RFC2518 adds "If" (which is obvious) and also explicitly "Overwrite" (but at least it's clear about it).  </s>
<s> As RFC2518 nowhere states that the "Lock-Token" header expresses a "precondition", I'm leaning to favorizing Apache's behaviour (which is *not* what IIS does...).  </s>
<s> Best regards, Julian  </s>
<s> s/410/400/g Sigh.  </s>
<s> Since none of the current implementations agree, I'd go with the one that seemed to be trying the hardest to implement what the specification says, and I agree with Julian that this is the Apache behavior.  </s>
<s> Cheers, Geoff Julian wrote on 06/07/2004 03:35:49 AM:  </s>
<s> 412.  </s>
<s> Is there some advantage to having a different error code for these two cases, or distinguishing between this error and the dozens of problems that can cause a 400 response?  </s>
<s> Apache's model does not distinguish what the error is.  </s>
<s> So the Microsoft approach has the advantage of distinguishing the two different cases.  </s>
<s> The Xythos/SAP approach has the  </s>
<s> advantage of using a more specific code (400 is the most generic form of bad request code, therefore less specific than 412) although it's the same for both these cases under discussion.  </s>
<s> However, 412 is a little too specific for the case where the client omitted the lock token header entirely -- clients shouldn't have to expect a 412 error when the client sends a request without any "conditional" headers at  </s>
<s> all.  </s>
<s> I don't have a strong opinion here so I'm not disagreeing with Geoff; I just don't know what's a good reason on which to base our choice, and wanted to list a few potential justifications.  </s>
<s> Yet another justification could be "we have two servers doing it the same way, let's do it that way".  </s>
<s> Any other commenters before we declare a (very rough) consensus?  </s>
<s> .Mac  </s>
<s> server implementors could tell us what they do...  </s>
<s> Lisa  </s>
<s> I was asking because we have an open issue on that.  </s>
<s> It seems that we can't guarantee a particular server behaviour, but I was still wondering what would be the most correct status for each of these cases.  </s>
<s> The spec *should* state something about that.  </s>
<s> That being said, a spec revision should define specific precondition names, in which case what kind of 4xx is returned becomes less important.  </s>
<s> A new client will just detect the general failure code, and then take a look at the response body.  </s>
<s> Correct.  </s>
<s> So it would be nice if we could decide whether "lock-tokem" is an header that contributes to "precondition" checks as defined per RFC2616 (I think it shouldn't).  </s>
<s> Best regards, Julian  </s>
<s> In the pending maintenance release running in our lab (not necessarily what's up on .mac  </s>
<s> today), we return, respectively: HTTP/1.1 412 Precondition Failed: Lock-Token header missing HTTP/1.1 409 Conflict: Lock-Token is invalid  </s>
<s> .Mac server implementors could tell us what they do...  </s>
<s> JS "Jake" Baumgarten Apple .Mac  </s>
<s> Backend Server Engineering jbaumgarten@apple.com Loc: VG5-1045 MS: 82-EC 20605 Valley Green Dr, Cupertino CA 95014 USA www.apple.com  </s>
<s> .Mac server implementors could tell us what they do...  </s>
<s> Jake, thanks for the feedback.  </s>
<s> This contributes to the picture -- clients will have to expect almost everything between 400 and 499.  </s>
<s> At the end of the day, a revised spec should - define specific RFC3253-like precondition identifiers, so that new software can precisely find out what went wrong, - give server implementors guidelines which 4xx code to choose (in particular, we should answer that question whether "lock-token" contributes to the set of request headers that can cause a 412 Precondition Failed), - give client implementors guidelines how to interpret server responses (such as first check for DAV:error response body, then possibly fall back to generic HTTP status usage).  </s>
<s> I'll try to capture this in today.  </s>
<s> Best regards, Julian  </s>
